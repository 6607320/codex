# === quest_7_3.py ===
# Квест: 7.3 - Генерация с личной Печатью
# Цель: Использовать наш обученный артефакт - "Стилевую Печать" (LoRA) -
# чтобы заставить Духа-Демиурга творить в нашем уникальном, выученном стиле.

# --- Акт 1: Подготовка Гримуаров ---

# Призываем наш силовой гримуар PyTorch.
import torch

# Призываем "Диффузионный Конвейер" для творения.
from diffusers import DiffusionPipeline

# Призываем специальный инструмент для работы с "блокнотами" (нашей Печатью).
from peft import PeftModel

# Призываем помощника 'os' (хотя он здесь и не используется, это хорошая привычка).

# --- Акт 2: Призыв "Чистого" Демиурга ---

print("Призываю 'чистого' Духа-Демиурга...")
# Имя базовой модели, на которой мы обучали нашу Печать.
model_id = "CompVis/stable-diffusion-v1-4"

# Призываем стандартный конвейер Stable Diffusion.
pipe = DiffusionPipeline.from_pretrained(
    model_id,
    # Используем руну экономии VRAM, загружая модель в 16-битном формате.
    torch_dtype=torch.float16,
    # Отключаем "Цензора", так как он может конфликтовать с нашим новым стилем.
    safety_checker=None,
)

# --- Акт 3: Ритуал Наложения "Стилевой Печати" ---

# Указываем путь к папке, где лежит наш обученный артефакт.
seal_path = "artist_seal"
print(f"Загружаю твою 'Стилевую Печать' из папки '{seal_path}'...")

# КЛЮЧЕВОЕ ЗАКЛИНАНИЕ
# pipe.unet - это "сердце" Демиурга, его Дух-Скульптор.
# PeftModel.from_pretrained - это заклинание, которое "одевает" чистого духа
# в нашу обученную "магическую броню" (LoRA). Оно читает конфиг из папки,
# находит нужные "отделы мозга" и прикрепляет к ним наши обученные "записи".
pipe.unet = PeftModel.from_pretrained(pipe.unet, seal_path)

# Теперь, когда Демиург "просветлен", мы перемещаем весь конвейер на Кристалл Маны.
pipe = pipe.to("cuda")
print("Печать успешно наложена! Демиург готов творить в твоем стиле.")

# --- Акт 4: Ритуал Творения ---

# Создаем новое текстовое заклинание (промпт). Мы просим нарисовать то,
# чего не было в нашем "учебнике" (астронавта), чтобы проверить,
# переносится ли сам СТИЛЬ.
# ВАЖНО: мы добавляем наше "магическое слово-активатор" - 'in sks style'.
# Именно оно "пробуждает" знания из нашей Печати.
prompt = "a portrait of an astronaut, in sks style"

print(f"\nШепчу Демиургу новое заклинание: '{prompt}'")
print("Демиург начинает творить...")

# Используем защитное заклинание `torch.no_grad()` для экономии маны.
with torch.no_grad():
    # Запускаем конвейер творения.
    # num_inference_steps=50 - указываем, что ритуал должен состоять из 50 шагов "очистки от шума".
    # .images[0] - извлекаем первый (и единственный) сотворенный образ.
    image = pipe(prompt, num_inference_steps=50).images[0]

# --- Акт 5: Сохранение Шедевра ---

# Имя для нашего финального, уникального артефакта.
save_path = "astronaut_in_my_style.png"
# Материализуем образ, сохраняя его в файл.
image.save(save_path)
print(f"\nМагия свершилась! Твой шедевр сохранен в файл '{save_path}'")
