# quest_8_2.py Specification

## 1. Meta Information

- Domain: Scripting
- Complexity: High
- Language: Python
- Frameworks: PyTorch, OpenCV (cv2), transformers, tqdm
- Context: Independent Artifact

## 2. Goal & Purpose (Легенда)

Этот модуль — мост между старой вечной магией конвейеров обработки визуальных данных и современной трансферной алхимией. Он строит конвейер для классификации действий в видео без обучения с нуля: использует два исходных видео как учебник, прореживает кадры, извлекает из каждого кадра визуальные эссенции through Всевидящего Духа и усредняет их в единый отпечаток для каждого видео. На основе этих отпечатков Голем-Ученику дается задача различать два класса действий. Это доказательствo возможности собрать мощь прошлых Свитков и современных нейросетей в одну единую задачу.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- Source: CLI Args
- Format: JSON
- Schema:
  interface InputData {
  videoRootPath: string; // корень видеодатасета, например video*palette
  frameSkip?: number; // шаг прореживания кадров, например 5
  labelMap?: { [key: string]: number }; // отображение имен классов на номера, по умолчанию {"action_A":0,"action_B":1}
  device?: string; // вычислительное устройство, например "cuda" или "cpu"
  processorModel?: string; // модель процессора изображений, например "google/mobilenet_v2_1.0_224"
  extractorModel?: string; // модель-извлекатель признаков, например "google/mobilenet_v2_1.0_224"
  videoPattern?: string; // паттерн поиска видео, например "video_palette/\**/\_.mp4"
  }

### 3.2. Outputs (Выходы)

- Destination: STDOUT
- Format: JSON
- Success Criteria: Сообщение о завершении обучения с итоговой потерей (Loss) и статусом выполнения
- Schema:
  interface OutputResult {
  finalLoss?: number; // последняя зафиксированная ошибка обучения
  status: "completed" | "skipped" | "error";
  message?: string; // дополнительное пояснение
  }

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

1. Подготовка ритуалов знаний: подключаются и приводятся в боевую готовность необходимые библиотеки: glob для поиска файлов, os для работы с путями, cv2 для чтения кадров, torch и его модули для вычислений и обучения, tqdm для прогресс-баров и трансформеры для извлечения признаков через предобученную модель.
2. Призыв Всевидящего Духа: создаются процессор изображений и модель-извлекатель через предобученную архитектуру MobileNetV2 (конкретные идентификаторы моделей задаются строками).
3. Извлечение эссенций видео: для каждого найденного видео открвается поток, кадры прореживаются по заданному frameSkip и добавляются в учебную коллекцию video_frames. Если видео оказывается слишком коротким и кадры не извлечены, оно пропускается.
4. Прерисовка меток: из имени родительской папки видео определяется класс (например action_A или action_B) и переводится в числовой лейбл через label_map.
5. Извлечение эссенций кадра: весь набор кадров подается в процессор и извлекается эмбеддинг каждого кадра через предобученную модель-извекторизатор. Затем эти эмбеддинги усредняются по кадрам каждого видео, получая единый вектор-отпечаток для видео.
6. Формирование набора данных: объединяются эмбеддинги всех видео в одну тензорную матрицу и соответствующие метки в другой тензор на том же устройстве.
7. Создание Голема-Ученика: строится простой классификатор на основе линейного слоя, принимающего размер входного признака 1280 и выдающего два класса.
8. Наставление Голема: на протяжении 50 эпох выполняется цикл обучения с нулем градиента, прямым прохождением через классификатор, подсчетом кросс-энтропийной ошибки, обратным распространением ошибки и обновлением параметров;
9. Финал: печатается последнее значение потери и завершающее сообщение о разборе движений.

### 4.2. Declarative Content (Для конфигураций и данных)

Скрипт работает с набором конфигураций и датасета, где:

- Путь к видео — video_palette, с произвольной вложенной структурой подпапок, где каждая подпапка соответствует классу действия (например action_A или action_B).
- Прореживание кадров задаётся параметром frameSkip, по умолчанию 5.
- Карта классов задаётся как словарь labelMap, по умолчанию action_A → 0, action_B → 1.
- Модели на стороне извлечения признаков — MobileNetV2 через AutoImageProcessor и AutoModel с использованием устройства CUDA.
- Сохранение итогов не выполняется в файлах — итоговый результат выводится в консоль в виде финальной ошибки и статуса.

## 5. Structural Decomposition (Декомпозиция структуры)

- Входной блок
  - Инициализация путей и параметров (videoRootPath, frameSkip, device)
  - Установка labelMap
- Блок подготовки артефактов
  - globbing файлов видео
  - подготовка карты классов
- Блок кадроизвлечения
  - открытие видео, чтение кадров, прореживание
  - пропуск видео без кадров
- Блок маппинга меток
  - извлечение имени класса из пути и перевод в числовой индекс
- Блок извлечения признаков
  - обработка кадров через процессор, вычисление эмбеддингов и усреднение
- Блок агрегации данных
  - формирование embeddings_tensor и labels_tensor
- Блок моделирования
  - создание линейного классификатора
  - выбор функции потерь и оптимизатора
- Блок обучения
  - цикл по эпохам, прямой проход, расчет потерь, обратное распространение, шаг оптимизации
- Блок вывода
  - печать последней потери и завершающего сообщения

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- Performance: ориентирован на использование GPU (device чаще всего "cuda"); обработка включает тяжелые операции по извлечению признаков и обучение простой модели.
- Concurrency: синхронная последовательная обработка; нет явной конкуренции или асинхронности.
- Dependencies: glob, os, cv2, torch, torch.nn, torch.optim, tqdm, transformers (AutoImageProcessor, AutoModel).
- Ритмическая память: требуется значительная видеопамять для хранения эмбеддингов и батчей кадров.

### 6.2. Prohibited Actions (Negative Constraints)

- Не хранить секреты в открытом виде в конфигурациях или коде; использовать безопасные источники параметров.
- Не выводить в продакшн полные данные или сырые конвейерные вычисления в консоль без нужды.
- Не выполнять синхронные сетевые вызовы в критичных местах цикла обучения.
- Не упаковывать конфигурационные файлы .yaml или .json внутрь скриптов без явной причины.
- Не изменять версии зависимостей или пути к файлам в процессе реконструкции артефакта.

## 7. Verification & Testing (Верификация)

Герхин-сценарии

Функциональная проверка: Хэппи-путь
Feature: Script Functionality
Scenario: Successful execution
Given видеопапка video_palette существует и содержит по крайней мере видео для action_A и action_B
When скрипт quest_8_2.py запускается из командной строки
Then обучающий цикл завершится и на экране будет видна строка Финальная Ошибка (Loss) и сообщение Ритуал завершен! Голем научился отличать 'движение вправо' от 'увеличения.'

Проверка на обработку ошибок/критических ситуаций
Scenario: No eligible videos found
Given video_palette пуст или не содержит mp4 файлов
When скрипт quest_8_2.py запускается
Then скрипт завершится без выдачи обучающего сообщения или с информированным статусом об отсутствии данных
And в выводе будет указан статус error или skipped и соответствующее пояснение

Примечание: в реальном окружении сценарии могут требовать адаптации под конкретную структуру файлов и доступных моделей, но дух ритуала сохранится — конвейер должен проходить от сбора материалов до финального осенения результата.
