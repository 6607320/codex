# === quest_7_3.py ===
# Имя этого пергамента, хранящего ритуал финального творения.
# Квест: 7.3 - Генерация с личной Печатью
# Каноническое имя Квеста, как оно записано в Великом Кодексе.
# Цель: Использовать наш обученный артефакт - "Стилевую Печать" (LoRA) -
# чтобы заставить Духа-Демиурга творить в нашем уникальном, выученном стиле.
# Священная цель нашего ритуала: применить наши знания на практике.

# --- Акт 1: Подготовка Гримуаров ---
# Первый акт: мы призываем все необходимые знания и инструменты для ритуала.

# Мы призываем наш главный силовой гримуар `PyTorch`, источник всей магической энергии.
import torch

# Мы призываем чертеж `DiffusionPipeline` из гримуара `diffusers` для магии творения.
from diffusers import DiffusionPipeline

# Мы призываем специальный инструмент `PeftModel` для работы с "блокнотами" (нашей Печатью).
from peft import PeftModel

# Мы призываем "Духа-Архивариуса" `os` (хотя он здесь и не используется, это хорошая привычка).
import os

# --- Акт 2: Призыв "Чистого" Демиурга ---
# Второй акт: мы призываем базового Духа-Демиурга, которого будем "просветлять".

# Мы оглашаем на кристалл (консоль) о начале ритуала призыва.
print("Призываю 'чистого' Духа-Демиурга...")
# Мы указываем имя базовой модели, на которой мы обучали нашу Печать.
model_id = "CompVis/stable-diffusion-v1-4"

# Мы призываем стандартный конвейер Stable Diffusion.
pipe = DiffusionPipeline.from_pretrained(
    # Мы называем имя Духа, которого призываем.
    model_id,
    # Мы используем руну экономии VRAM, загружая модель в "легком" 16-битном формате.
    torch_dtype=torch.float16,
    # Мы отключаем "Цензора", так как он может конфликтовать с нашим новым стилем.
    safety_checker=None,
)

# --- Акт 3: Ритуал Наложения "Стилевой Печати" ---
# Третий, самый важный акт: мы "просветляем" Демиурга нашими знаниями.

# Мы указываем точный путь к папке, где лежит наш обученный артефакт.
seal_path = "artist_seal"
# Мы оглашаем на кристалл, что нашли наш артефакт.
print(f"Загружаю твою 'Стилевую Печать' из папки '{seal_path}'...")

# КЛЮЧЕВОЕ ЗАКЛИНАНИЕ
# `pipe.unet` — это "сердце" Демиурга, его Дух-Скульптор, к которому мы обращаемся.
# `PeftModel.from_pretrained` — это заклинание, которое "одевает" чистого духа
# в нашу обученную "магическую броню" (LoRA), заменяя его волю нашей.
pipe.unet = PeftModel.from_pretrained(pipe.unet, seal_path)

# Теперь, когда Демиург "просветлен", мы перемещаем весь конвейер на Кристалл Маны.
pipe = pipe.to("cuda")
# Мы оглашаем, что ритуал "Просветления" завершен.
print("Печать успешно наложена! Демиург готов творить в твоем стиле.")

# --- Акт 4: Ритуал Творения ---
# Четвертый, кульминационный акт: мы даем "просветленному" Демиургу новое задание.

# Мы создаем новое текстовое заклинание (промпт).
# Мы просим нарисовать то, чего не было в нашем "учебнике" (астронавта), чтобы проверить,
# переносится ли сам СТИЛЬ. ВАЖНО: мы добавляем наше "магическое слово-активатор" - 'in sks style'.
# Именно оно "пробуждает" знания, запечатанные в нашей Печати.
prompt = "a portrait of an astronaut, in sks style"

# Мы оглашаем на кристалл, какое именно новое заклинание мы шепчем Демиургу.
print(f"\nШепчу Демиургу новое заклинание: '{prompt}'")
# Мы сообщаем, что самый таинственный этап — сотворение образа — начался.
print("Демиург начинает творить...")

# Мы используем защитное заклинание `torch.no_grad()` для экономии маны.
with torch.no_grad():
    # Мы запускаем конвейер творения.
    image = pipe(
        # Мы передаем ему наш промпт с "магическим словом".
        prompt,
        # Мы указываем, что ритуал должен состоять из 50 шагов "очистки от шума".
        num_inference_steps=50,
        # Мы извлекаем первый (и единственный) сотворенный образ из результата.
    ).images[0]

# --- Акт 5: Сохранение Шедевра ---
# Финальный акт: мы материализуем наш уникальный шедевр.

# Мы даем имя нашему финальному, уникальному артефакту.
save_path = "astronaut_in_my_style.png"
# Мы материализуем эфемерный образ из памяти, сохраняя его в файл на диске.
image.save(save_path)
# Мы оглашаем на кристалл, что ритуал успешно завершен, и шедевр сохранен.
print(f"\nМагия свершилась! Твой шедевр сохранен в файл '{save_path}'")
