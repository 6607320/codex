# quest_4_2.py Specification

## 1. Meta Information

- Domain: Scripting
- Complexity: Medium
- Language: Python
- Frameworks: OpenCV (cv2)
- Context: Independent Artifact

## 2. Goal & Purpose (Цель и Назначение)

Легенда: этот файл является простым, но мощным Ритуалом видеанализа, который учит машину видеть изменение во времени через базовую технику вычитания кадров. Задача — собрать карту движения как Эфир изменений между двумя последовательными моментами времени, послужив фундаментом для систем наблюдения и контроля качества.

Instruction for AI: This section provides high-level intent. Use it to understand the "WHY" of the code.

Этот модуль реализует базовую обработку изображений: поджидание двух кадров, вычисление их абсолютной разницы, преобразование к градационному виде и пороговую чистку, чтобы получить карту движения и сохранить её как артефакт на диск.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- Source: CLI Args
- Format: Text
- Schema:
  interface InputData {
  frame1Path: string;
  frame2Path: string;
  outputPath?: string;
  threshold?: number;
  }

### 3.2. Outputs (Выходы)

- Destination: File
- Format: Binary (Image)
- Success Criteria: Exit Code 0
- Schema:
  interface OutputResult {
  motionMaskPath: string;
  success: boolean;
  error?: string;
  }

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

- Ритуал начинается с призыва источников: указывается две карты времени и путь к месту сохранения артефакта.
- Введите Две карты времени: загрузите frame1Path и frame2Path через магическую силу загрузчика изображений.
- Призовите Заклинание Вычитания: вычислите абсолютную разницу между двумя изображениями; результат — карта различий.
- Преобразование душ изображений: переведите различие из цветного пространства BGR в однотонное GRAY, чтобы очистить цветовую боль и оставить яркость как меру изменений.
- Прозрачная очистка: наложите пороговую защиту — всё, что ниже порога, становится хаосом, а всё выше порога — светом, образуя бинарную маску движения.
- Финализация артефакта: сохраните полученную маску на диск под именем motion_detected.png.
- Сообщения о ходе ритуала: выводите понятные подсказки в консоль на каждом этапе.
- Коррекция и ошибки: если один из входов недоступен, ритуал прерывается с описанием хаоса и без сохранения артефакта.

### 4.2. Declarative Content (Для конфигураций и данных)

Указаны точные параметры и пути, использованные в процессе 1-в-1:

- frame1Path: ../Quest_1/frames/frame_1.jpg
- frame2Path: ../Quest_1/frames/frame_2.jpg
- outputPath: motion_detected.png
- threshold: 25
- Преобразование: BGR -> GRAY
- Результат: бинарная карта движения motion_mask, сохраненная как motion_detected.png

## 5. Structural Decomposition (Декомпозиция структуры)

- Нет определённых функций или классов — это процедурный скрипт, который исполняется сверху вниз.
- Основные логические блоки:
  - Подготовка ритуалов и загрузка путей к кадрам
  - Зачитывание двух кадров
  - Вычитание образов
  - Преобразование в градации серого
  - Применение порогового фильтра
  - Сохранение артефакта
  - Сообщения о ходе ритуала

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- Performance: стандартный CPU, обработка двух небольших кадров за одну операцию
- Concurrency: синхронный (последовательный) ритуал
- Dependencies: OpenCV Python (cv2)

### 6.2. Prohibited Actions (Negative Constraints)

- НЕЛЬЗЯ хранить секреты в открытом виде
- НЕЛЬЗЯ выводить сырые данные в консоль в продакшене
- НЕЛЬЗЯ выполнять сетевые вызовы синхронно в основном цикле
- НЕЛЬЗЯ оборачивать конфигурационные файлы в скрипты
- НЕЛЬЗЯ менять версии библиотек или пути во время реконструкции

## 7. Verification & Testing (Верификация)

Геркин сценарии

Feature: Ритуал обнаружения движения
Scenario: Успешное создание карты движения
Given существуют файлы frame_1.jpg и frame_2.jpg по указанным путям
When выполняется ритуал движения
Then создаётся артефакт motion_detected.png
And артефакт доступен на диске

Scenario: Ошибка загрузки кадра
Given один из входных кадров недоступен по указанному пути
When запускается ритуал
Then процесс завершается с сообщением об хаосе и артефакт не создаётся
