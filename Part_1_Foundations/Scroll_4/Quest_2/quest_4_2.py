# === quest_4_2.py ===
# Имя этого пергамента, которое будет занесено в священную Летопись Кодекса.
# Квест: 4.2 - Обнаружение движения
# Каноническое имя Квеста, описывающее его суть.
# Цель: Освоить базовую технику видеоаналитики - вычитание кадров.
# Здесь изложена главная цель нашего ритуала.
# Этот простой, но мощный принцип позволяет "увидеть" изменения
# между двумя моментами времени.
# А здесь — объяснение, почему эта магия так важна для Техноманта.

# --- Акт 1: Подготовка Гримуаров ---
# Мы начинаем первый магический акт: призыв знаний из великих библиотек.

# Мы призываем могущественный гримуар `cv2` (OpenCV), известный как "Набор
# Кинематографиста".
import cv2

# Здесь ты, Маг-Техномант, оставил запись о намерении призвать `numpy`,
# верного помощника для работы с числовыми массивами, из которых состоят все образы.
# Призываем помощника 'numpy' для работы с массивами (образами).

# --- Акт 2: Загрузка "Карт Времени" ---
# Второй акт: мы призываем два среза времени, два образа, чтобы сравнить их.

# Мы оглашаем на кристалл (консоль) о начале загрузки наших артефактов.
print("Загружаю две карты из колоды: кадр 1 и кадр 2...")
# Мы используем заклинание `imread` из гримуара `cv2`, чтобы загрузить два образа,
# представляющих два последовательных момента времени.
frame1 = cv2.imread("frames/frame_1.jpg")
frame2 = cv2.imread("frames/frame_2.jpg")

# --- Акт 3: Ритуал "Магического Вычитания" ---
# Третий, кульминационный акт: мы сравниваем два среза времени, чтобы
# найти разницу.

# Мы оглашаем на кристалл о начале самого важного этапа ритуала.
print("Начинаю ритуал 'Вычитания образов' для поиска различий...")
# Мы произносим заклинание `cv2.absdiff`, которое вычисляет "абсолютную разницу"
# между двумя образами. Оно сравнивает каждый пиксель `frame1` с соответствующим
# пикселем `frame2` и создает новый образ `difference`, где яркость пикселя
# равна силе различия. Черный цвет — нет разницы, светлый — разница есть.
difference = cv2.absdiff(frame1, frame2)

# --- Акт 4: Усиление и Очистка "Карты Движения" ---
# Четвертый акт: мы обрабатываем полученную карту различий, чтобы сделать
# ее четкой и ясной.

# Шаг 4.1: Мы лишаем "Карту Различий" ее цветовой души,
#  чтобы работать только с яркостью.
# cv2.cvtColor — это заклинание для изменения цветового пространства.
# Мы превращаем цветной образ (BGR) в одноканальный, черно-белый (GRAY).
# Это упрощает дальнейший анализ, сводя три числа на пиксель (B, G, R) к
# одному.
gray_difference = cv2.cvtColor(difference, cv2.COLOR_BGR2GRAY)

# Шаг 4.2: Мы применяем "Заклинание Контраста" для очистки от шума.
# `cv2.threshold` — это могущественный фильтр, который делит мир на черное и белое.
# 1. `gray_difference` — образ, который мы фильтруем.
# 2. `25` — порог. Все, что тусклее этого значения,
#  будет считаться тьмой (незначительным шумом).
# 3. `255` — значение для света. Все, что ярче порога,
#  станет чисто-белым (явным движением).
# 4. `cv2.THRESH_BINARY` — тип фильтра: "или тьма, или свет".
# `_` — это знак мудрого мага,
#  который игнорирует ненужный побочный результат заклинания,
# забирая лишь самое ценное — нашу финальную "маску движения" `motion_mask`.
_, motion_mask = cv2.threshold(gray_difference, 25, 255, cv2.THRESH_BINARY)
# Мы сообщаем, что главный артефакт этого ритуала успешно сотворен.
print("Карта движения создана.")

# --- Акт 5: Сохранение Артефакта ---
# Финальный акт: мы материализуем нашу "Карту Движения", чтобы ее можно
# было изучить.

# Заклинание `cv2.imwrite` сохраняет наш артефакт `motion_mask` на диск в
# виде файла.
cv2.imwrite("motion_detected.png", motion_mask)
# Мы оглашаем на кристалл, что ритуал успешно завершен и артефакт сохранен.
print(
    "\nМагия свершилась! 'Карта движения' сохранена в файл 'motion_detected.png'"
)
# Это важное наставление от Мастера Гильдии, объясняющее, как толковать результат.
# Так как наши исходные кадры были идентичны, отсутствие движения (черная карта) — это
# признак того, что наш ритуал сработал безупречно.
print(
    "(Примечание: так как наши кадры были одинаковы, "
    "карта движения будет черной. Это УСПЕХ!)"
)
