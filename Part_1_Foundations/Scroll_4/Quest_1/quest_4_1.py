"""Квест 4.1: Деконструкция Кинопленки.

Этот пергамент открывает "Свиток Магии Оживших Кадров". Его главная цель
(МАКРО-контекст) — освоить базовый ритуал работы с видео: его деконструкцию.

Мы учимся "разбирать" магическую кинопленку (`.mp4`) на ее составляющие —
отдельные статичные изображения (кадры). Ритуал использует "Набор
Кинематографиста" (`OpenCV`), чтобы "захватить" видеопоток и в цикле
извлекать из него кадры один за другим, сохраняя их как отдельные файлы.
Этот квест доказывает, что для машины "видео" — это просто последовательность
картинок, и закладывает фундамент для всего будущего видеоанализа.
"""

# --- Часть I: Импорт Магических Гримуаров ---
# Первый раздел: мы призываем все необходимые знания и инструменты.
# Мы призываем "Духа-Архивариуса" (`os`) для работы с папками.
import os

# Мы призываем `cv2` (OpenCV) — "Набор Кинематографиста".
import cv2

# --- Часть II: Ритуал Деконструкции Кинопленки ---
# Начинается вторая, кульминационная часть: мы разбираем сотворенный артефакт.
# Мы оглашаем на кристалл о начале ритуала деконструкции.
print("--- Ритуал Деконструкции Кинопленки ---")

# Мы задаем имя папки, куда мы будем складывать наши "выхваченные" кадры.
output_folder = "frames"
# Мы проверяем, существует ли уже такая папка.
if not os.path.exists(output_folder):
    # Если нет, мы создаем ее.
    os.makedirs(output_folder)

# Мы "захватываем" кинопленку `test_video.mp4`, создавая
# "объект-проигрыватель".
video_path = "test_video.mp4"
# Мы создаем "проигрыватель".
video_capture = cv2.VideoCapture(video_path)

# Мы проверяем, удалось ли "захватить" кинопленку.
if not video_capture.isOpened():
    # Если нет, мы сообщаем об ошибке.
    print(f"Ошибка: Не удалось открыть кинопленку '{video_path}'.")
    # Мы даем наставление, как исправить ошибку.
    print("Убедись, что сначала был исполнен ритуал 'create_video.py'.")
    # Мы прерываем ритуал.
    exit()

# Мы готовим "счетчик" для нумерации извлеченных кадров.
frame_count = 0
# Мы начинаем "бесконечный" магический круг, который будет читать кадры.
while True:
    # Мы читаем следующий кадр из кинопленки.
    success, frame = video_capture.read()
    # Мы проверяем, удалось ли прочитать кадр.
    if not success:
        # Если нет (кадры закончились), мы разрушаем магический круг.
        break

    # Мы создаем уникальное имя для каждого кадра.
    frame_filename = os.path.join(output_folder, f"frame_{frame_count}.jpg")
    # Мы материализуем кадр, сохраняя его как изображение на диске.
    cv2.imwrite(frame_filename, frame)
    # Мы увеличиваем наш счетчик.
    frame_count += 1

# Мы "освобождаем" кинопленку, завершая работу с ней.
video_capture.release()

# Мы оглашаем финальный результат нашего ритуала деконструкции.
print(
    f"Ритуал завершен. {frame_count} кадров извлечено в папку '{output_folder}'."
)
