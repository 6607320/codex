"""–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: –ê—É–¥–∏—Ç–æ—Ä –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –õ–µ—Ç–æ–ø–∏—Å–∏.

–≠—Ç–æ—Ç –ø–µ—Ä–≥–∞–º–µ–Ω—Ç ‚Äî "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ú–∞—Å—Ç–µ—Ä–∞", –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
–∏ –ø–æ–ª–Ω–æ—Ç—ã –õ–µ—Ç–æ–ø–∏—Å–∏ (`manifest.json`). –û–Ω —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ö–æ–¥–µ–∫—Å–∞ (—Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ) —Å —Ç–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ, –∏ –≤—ã—è–≤–ª—è–µ—Ç
–ª—é–±—ã–µ "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ" —Å–≤–∏—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω—ã `rag_builder.py`.

–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç `manifest.json`, —Å–æ—Å—Ç–∞–≤–ª—è—è —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
2. –°–∫–∞–Ω–∏—Ä—É–µ—Ç —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–æ–µ–∫—Ç–∞, –Ω–∞—Ö–æ–¥—è –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã.
3. –°–≤–µ—Ä—è–µ—Ç –¥–≤–∞ —Å–ø–∏—Å–∫–∞ –∏ —Å–æ–æ–±—â–∞–µ—Ç –æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö.
"""

# –ü—Ä–∏–∑—ã–≤–∞–µ–º –¥—É—Ö–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏.
import os

# –ü—Ä–∏–∑—ã–≤–∞–µ–º –¥—É—Ö–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JSON –¥–ª—è —á—Ç–µ–Ω–∏—è –õ–µ—Ç–æ–ø–∏—Å–∏.
import json

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –†–∏—Ç—É–∞–ª–∞ ---
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ö–æ–¥–µ–∫—Å–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–µ—Å—Ç–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞.
PROJECT_ROOT = "../../"
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞-–õ–µ—Ç–æ–ø–∏—Å–∏.
MANIFEST_FILE = "manifest.json"
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –º—ã –±—É–¥–µ–º –∏—Å–∫–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
TARGET_EXTS = (".md", ".py")


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª –∞—É–¥–∏—Ç–∞.
def audit():
    """–ü—Ä–æ–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç, —Å—Ä–∞–≤–Ω–∏–≤–∞—è —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ —Å manifest.json."""
    # –í—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—á–∞–ª–∞ —Ä–∏—Ç—É–∞–ª–∞.
    print("--- –ù–ê–ß–ê–õ–û –ê–£–î–ò–¢–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ---")

    # --- –§–∞–∑–∞ 1: –ß—Ç–µ–Ω–∏–µ –õ–µ—Ç–æ–ø–∏—Å–∏ (manifest.json) ---
    # –ù–∞—á–∏–Ω–∞–µ–º —Ä–∏—Ç—É–∞–ª –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π –æ—Ö—Ä–∞–Ω–Ω—ã—Ö —Ä—É–Ω –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –õ–µ—Ç–æ–ø–∏—Å–∏.
    try:
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–≤–∏—Ç–æ–∫ –õ–µ—Ç–æ–ø–∏—Å–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è.
        with open(MANIFEST_FILE, "r", encoding="utf-8") as f:
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç —Å–≤–∏—Ç–∫–∞ –∏–∑ JSON –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.
            data = json.load(f)
    # –ï—Å–ª–∏ –õ–µ—Ç–æ–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞...
    except FileNotFoundError:
        # ...—Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ –∏ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∏—Ç—É–∞–ª.
        print(f"‚ùå –û—à–∏–±–∫–∞: {MANIFEST_FILE} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é.
        return

    # --- –§–∞–∑–∞ 2: –°–±–æ—Ä –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ ---
    # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π –∏–∑ –õ–µ—Ç–æ–ø–∏—Å–∏.
    indexed_files_abs = set()
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π.
    current_dir = os.getcwd()

    # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ "—Ç–æ–º–∞" (chunks), –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –õ–µ—Ç–æ–ø–∏—Å–∏.
    for chunk in data.get("chunks", []):
        # –í –∫–∞–∂–¥–æ–º —Ç–æ–º–µ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∏.
        for source in chunk.get("sources", []):
            # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∏–∑ –õ–µ—Ç–æ–ø–∏—Å–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π.
            abs_path = os.path.abspath(os.path.join(current_dir, source))
            # –î–æ–±–∞–≤–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –≤ –Ω–∞—à–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ.
            indexed_files_abs.add(abs_path)

    # –í—ã–≤–æ–¥–∏–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –õ–µ—Ç–æ–ø–∏—Å–∏.
    print(f"üìö –í –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ —á–∏—Å–ª–∏—Ç—Å—è —Ñ–∞–π–ª–æ–≤: {len(indexed_files_abs)}")

    # --- –§–∞–∑–∞ 3: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ (—Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ) ---
    # –ì–æ—Ç–æ–≤–∏–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–µ–π –∫ "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–º" —Ñ–∞–π–ª–∞–º.
    missing_files = []
    # –û–±–Ω—É–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É—Å–ø–µ—à–Ω–æ –Ω–∞–π–¥–µ–Ω—ã –≤ –õ–µ—Ç–æ–ø–∏—Å–∏.
    found_count = 0

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ß–µ—Ä–Ω—ã–π –°–ø–∏—Å–æ–∫ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
    exclude = {
        ".git",
        ".dvc",
        "notebooklm_sources",
        "__pycache__",
        "debug_output",
        "env",
        "venv",
    }

    # –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
    scan_root_abs = os.path.abspath(PROJECT_ROOT)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –í–µ–ª–∏–∫–∏–π –û–±—Ö–æ–¥ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞.
    for root, dirs, files in os.walk(scan_root_abs):
        # –ù–∞ –ª–µ—Ç—É –∏—Å–∫–ª—é—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–∑ –ß–µ—Ä–Ω–æ–≥–æ –°–ø–∏—Å–∫–∞.
        dirs[:] = [d for d in dirs if d not in exclude]

        # –í –∫–∞–∂–¥–æ–π –ø–∞–ø–∫–µ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.
        for file in files:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –Ω–∞—à–∏–º —Ü–µ–ª–µ–≤—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º.
            if file.endswith(TARGET_EXTS):
                # –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É —Ñ–∞–π–ª—É –Ω–∞ –¥–∏—Å–∫–µ.
                real_abs_path = os.path.abspath(os.path.join(root, file))

                # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∞–º —Ñ–∞–π–ª –õ–µ—Ç–æ–ø–∏—Å–∏, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø–æ–ø–∞–ª –≤ "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ".
                if "manifest.json" in file:
                    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ñ–∞–π–ª—É –≤ —Ü–∏–∫–ª–µ.
                    continue

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å —Ñ–∞–π–ª–∞
                # –≤ –Ω–∞—à–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ –∏–∑ –õ–µ—Ç–æ–ø–∏—Å–∏.
                if real_abs_path in indexed_files_abs:
                    # –ï—Å–ª–∏ –¥–∞, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö.
                    found_count += 1
                # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –≤ –õ–µ—Ç–æ–ø–∏—Å–∏...
                else:
                    # ...–≤—ã—á–∏—Å–ª—è–µ–º –µ–≥–æ –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞.
                    rel_path = os.path.relpath(real_abs_path, start=current_dir)
                    # –î–æ–±–∞–≤–ª—è–µ–º "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π" —Ñ–∞–π–ª –≤ —Å–ø–∏—Å–æ–∫.
                    missing_files.append(rel_path)

    # --- –§–∞–∑–∞ 4: –í—ã–Ω–µ—Å–µ–Ω–∏–µ –í–µ—Ä–¥–∏–∫—Ç–∞ ---
    # –í—ã–≤–æ–¥–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –Ω–∞–π–¥–µ–Ω—ã –∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏,
    # –∏ –≤ –õ–µ—Ç–æ–ø–∏—Å–∏.
    print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –Ω–∞–π–¥–µ–Ω–æ –≤ –∏–Ω–¥–µ–∫—Å–µ —Ñ–∞–π–ª–æ–≤: {found_count}")

    # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö" —Ñ–∞–π–ª–æ–≤ –Ω–µ –ø—É—Å—Ç...
    if missing_files:
        # ...–±—å–µ–º —Ç—Ä–µ–≤–æ–≥—É –∏ –≤—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫.
        print("\n‚ùå –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–∏ —Ñ–∞–π–ª—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã (–µ—Å—Ç—å –Ω–∞ –¥–∏—Å–∫–µ, –Ω–µ—Ç –≤ PDF):")
        # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∏ –≤—ã–≤–æ–¥–∏–º –∫–∞–∂–¥—ã–π "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–π" —Ñ–∞–π–ª.
        for f in missing_files:
            # –ü–µ—á–∞—Ç–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.
            print(f"   - {f}")
    # –ï—Å–ª–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ...
    else:
        # ...—Å–æ–æ–±—â–∞–µ–º –æ–± –∏–¥–µ–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –õ–µ—Ç–æ–ø–∏—Å–∏.
        print("\n‚ú® –ò–î–ï–ê–õ–¨–ù–û. –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –∏–Ω–¥–µ–∫—Å–∞—Ö PDF.")


# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç –ø—Ä–∏–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é.
if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª –∞—É–¥–∏—Ç–∞.
    audit()
