{
  "_meta": {
    "input_hash": "922294f2d8606d2a45634d3d5690658c"
  },
  "scenario": [
    {
      "command": "gcloud config get-value project",
      "output": "demo-quest-project\n",
      "is_final": false
    },
    {
      "command": "gcloud projects describe $(gcloud config get-value project) --format='value(projectNumber)'",
      "output": "123456789012\n",
      "is_final": false
    },
    {
      "command": "curl -s https://api.github.com/repos/alpha-dev/codex | head -n 1 | tr -cd '0-9'",
      "output": "987654321\n",
      "is_final": false
    },
    {
      "command": "gcloud services enable artifactregistry.googleapis.com --project='demo-quest-project'",
      "output": "Enabled artifactregistry.googleapis.com for project demo-quest-project\n",
      "is_final": false
    },
    {
      "command": "gcloud services enable run.googleapis.com --project='demo-quest-project'",
      "output": "Enabled run.googleapis.com for project demo-quest-project\n",
      "is_final": false
    },
    {
      "command": "gcloud services enable iamcredentials.googleapis.com --project='demo-quest-project'",
      "output": "Enabled iamcredentials.googleapis.com for project demo-quest-project\n",
      "is_final": false
    },
    {
      "command": "gcloud artifacts repositories create codex-golems --repository-format=docker --location=europe-west3 --description='Codex CI/CD Artifact Repository' --project='demo-quest-project'",
      "output": "Created artifact repository 'codex-golems' in europe-west3 for project demo-quest-project\n",
      "is_final": false
    },
    {
      "command": "gcloud iam service-accounts create github-actions-sa --display-name='Service Account for GitHub Actions' --project='demo-quest-project'",
      "output": "Created service account github-actions-sa@demo-quest-project.iam.gserviceaccount.com.\n",
      "is_final": false
    },
    {
      "command": "gcloud artifacts repositories add-iam-policy-binding codex-golems --project='demo-quest-project' --location='europe-west3' --member='serviceAccount:github-actions-sa@demo-quest-project.iam.gserviceaccount.com' --role='roles/artifactregistry.writer'",
      "output": "Updated IAM policy binding for repository 'codex-golems'.\n",
      "is_final": false
    },
    {
      "command": "gcloud projects add-iam-policy-binding demo-quest-project --member='serviceAccount:github-actions-sa@demo-quest-project.iam.gserviceaccount.com' --role='roles/run.admin'",
      "output": "Permissions updated: added member 'serviceAccount:github-actions-sa@demo-quest-project.iam.gserviceaccount.com' with role 'roles/run.admin' for project 'demo-quest-project'.\n",
      "is_final": false
    },
    {
      "command": "gcloud iam service-accounts add-iam-policy-binding 'github-actions-sa@demo-quest-project.iam.gserviceaccount.com' --member='serviceAccount:github-actions-sa@demo-quest-project.iam.gserviceaccount.com' --role='roles/iam.serviceAccountUser'",
      "output": "Updated IAM policy binding for service account user\n",
      "is_final": false
    },
    {
      "command": "gcloud iam workload-identity-pools create 'github-pool' --project='demo-quest-project' --location='global' --display-name='GitHub Actions Pool'",
      "output": "Created workload identity pool 'github-pool' in project demo-quest-project\n",
      "is_final": false
    },
    {
      "command": "gcloud iam workload-identity-pools providers create-oidc 'github-provider' --project='demo-quest-project' --location='global' --workload-identity-pool='github-pool' --display-name='GitHub Actions Provider' --attribute-mapping='google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository,attribute.repository_id=assertion.repository_id' --issuer-uri='https://token.actions.githubusercontent.com' --attribute-condition='assertion.repository_id == 123456789012''",
      "output": "Created provider 'github-provider' for pool 'github-pool'\n",
      "is_final": false
    },
    {
      "command": "gcloud iam service-accounts add-iam-policy-binding 'github-actions-sa@demo-quest-project.iam.gserviceaccount.com' --project='demo-quest-project' --role='roles/iam.workloadIdentityUser' --member='principalSet://iam.googleapis.com/projects/123456789012/locations/global/workloadIdentityPools/github-pool/attribute.repository/alpha-dev/codex'",
      "output": "Bound provider to service account as workloadIdentityUser\n",
      "is_final": false
    },
    {
      "command": "gcloud iam workload-identity-pools providers describe 'github-provider' --project='demo-quest-project' --location='global' --workload-identity-pool='github-pool' --format='value(name)'",
      "output": "projects/demo-quest-project/locations/global/workloadIdentityPools/github-pool/providers/github-provider\n",
      "is_final": false
    },
    {
      "command": "gh secret set GCP_WORKLOAD_IDENTITY_PROVIDER --repo alpha-dev/codex --body 'projects/demo-quest-project/locations/global/workloadIdentityPools/github-pool/providers/github-provider'",
      "output": "Secret GCP_WORKLOAD_IDENTITY_PROVIDER saved for repo alpha-dev/codex.\n",
      "is_final": false
    },
    {
      "command": "gh secret set GCP_SERVICE_ACCOUNT --repo alpha-dev/codex --body 'github-actions-sa@demo-quest-project.iam.gserviceaccount.com'",
      "output": "Secret GCP_SERVICE_ACCOUNT saved for repo alpha-dev/codex.\n",
      "is_final": false
    },
    {
      "command": "bash -lc 'echo \"# Trigger pipeline\" >> Part_4_Engineering/Scroll_32/Quest_1/main.py'",
      "output": "Appended '# Trigger pipeline' to Part_4_Engineering/Scroll_32/Quest_1/main.py\n",
      "is_final": false
    },
    {
      "command": "git add .",
      "output": "On branch main\nYour branch is up to date with 'origin/main'.\nChanges to be committed:\n\tmodified: Part_4_Engineering/Scroll_32/Quest_1/main.py\n",
      "is_final": false
    },
    {
      "command": "git commit -m \"feat(ci): Пробуждение автоматизированной кузницы\"",
      "output": "[main 1a2b3c4] feat(ci): Пробуждение автоматизированной кузницы\n 1 file changed, 1 insertion(+)\n",
      "is_final": false
    },
    {
      "command": "git push origin main",
      "output": "Enumerating objects: 6, done.\nCounting objects: 100% (6/6), done.\nDelta compressed 0/0\nPacking objects: 100% (6/6), done.\nTotal 6 (delta 0), reused 0 (delta 0)\nTo github.com:alpha-dev/codex.git\n   1a2b3c4..5f6e7d8  main -> main\n",
      "is_final": true
    }
  ]
}
