# app.js Specification

## 1. Meta Information

- **Domain:** Scripting
- **Complexity:** Medium
- **Language:** TypeScript
- **Frameworks:** Fetch API, DOM
- **Context:** ../AGENTS.md

## 2. Goal & Purpose (Цель и Назначение)

**Легенда для Создателя:** Этот артефакт служит ритуалом визуализации Великого Кодекса через веб-интерфейс. Он создает и заполняет INDEX_DATA, вызывая карту знаний из index.json и свитки квестов из quests/quest_id.json, затем формирует многоблоковую хронику Кодекса с интерактивной навигацией между частями, свитками и отдельными квестами. Вся логика построена как последовательность ритуалов: инициация источников эфирного знания, распределение сведений по залам, призыв к конкретному квесту и автоматический вывод сценариев в Терминал Авто-Пилота.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- **Source:** API Request
- **Format:** JSON
- **Schema:**
  interface InputData {
  // id может быть передан в строковом виде через параметры пути или запроса
  id?: string;
  }

Применяемые формы входа в Эфире — через URL параметры и сетевые зовЫ к архивам index.json и quests/quest_id.json.

### 3.2. Outputs (Выходы)

- **Destination:** STDOUT
- **Format:** Text
- **Success Criteria:** Exit Code 0
- **Schema:**
  interface OutputResult {
  success: boolean;
  message?: string;
  data?: any;
  }

Эфирный вывод представляет собой интерактивный DOM-отклик: построенные блоки залов и свитков, карточки квестов, а затем открытые окна Терминала и кнопки навигации между квестами.

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

- При инициации страницы запускается цепочка ритуалов: мир просыпается через событие DOMContentLoaded и сразу вызывается loadIndex.
- Ритуал loadIndex обращается к архиву index.json, добавляя в каждый зов временную печать времени, чтобы избегать старого эха кэша. Ответ конвертируется в чистую эссенцию JSON и сохраняется в INDEX_DATA.
- В случае несогласия хаоса (ошибки сети или отсутствия файла) поднимается бедственный знак на алтаре и мир блокируется, скрывая приложение.
- После успешного считывания карты миров вызывается Магический Компас router, который читает сигилы из адресной строки. Если id предусмотрен, призывается Призыв Квеста loadAndRenderQuest; иначе открывается Главный Зал — renderCodexPage.
- renderCodexPage очищает Алтарь app, группирует квесты по Частям, строит иерархию Залов: Части — Свитки — Свиточки (квесты) — Карточки. Активные квесты получают кликабельность и открывают соответствующий квест через quest.html?id=...
- loadAndRenderQuest(id) обращается к архиву quests/quest_id.json с частицой времени, чтобы видение было свежим. При отсутствии файла выводится сообщение об ошибке; иначе формируется макет Храма Знаний и запускается ритуал рендера.
- renderQuestView создает трехколоночный макет: Легенда, Авто-терминал и Манифест. В Терминале инициализируется автоматический режим, выводится приветствие Codex OS v3.0, затем последовательно проходят шаги сценария квеста, где каждый шаг может содержать команду и опциональный вывод.
- renderStaticTerminal отвечает за статическую постановку терминала: вывод приветствия, последовательность команд и ответов; скрывает активную строку ввода после завершения сценария; запускается визуальный переход к следующему квесту через showNextButton.
- showNextButton рассчитывает следующий квест в упорядоченном списке и, если он есть, создаёт кнопку перехода к нему; иначе выводится триумфальное сообщение об освоении последнего свитка.
- Весь вывод во взаимодействии с внешним миром завершается безопасно обновляемыми элементами DOM, включая обработку внешних ссылок и плавную прокрутку к началу.

### 4.2. Declarative Content (Для конфигураций и данных)

[Указ Ткачу и точные данные для воссоздания 1-в-1]

- INDEX_DATA: массив квестов с полями id, partNumber, partTitle, scrollTitle, status, title, manifest, legend, scenario
- quest структура: id, title, legend, manifest, scenario массив из шагов с полями command и опционально output
- Архивы: index.json и quests/quest_id.json, с привязкой к каждому квесту через id

## 5. Structural Decomposition (Декомпозиция структуры)

- INDEX_DATA скрижаль миров: источник с quests
- loadIndex ритуал вызова и трансформации index.json
- router Магический компас: анализирует параметры URL и направляет к нужному ритуалу
- renderCodexPage сборка зала Codex по Частям, Свиткам и Свиткам-подкатегориям
- renderQuestView храм знаний: трехколоночная компоновка Легенда, Авто-Терминал, Манифест
- renderStaticTerminal статический режим терминала
- showNextButton путеводная кнопка к следующему квесту
- loadAndRenderQuest призыв конкретного квеста и его визуализация
- Обработчики ошибок Хаос и их визуальное оформление на алтаре

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- **Performance:** Standard CPU
- **Concurrency:** Асинхронные операции через fetch с timestamp в запросах для предотвращения кэша; обработка событий DOMContentLoaded и кликов по карточкам
- **Dependencies:** Fetch API, браузерная среда DOM, window, document; внешних библиотек нет

### 6.2. Prohibited Actions (Negative Constraints)

- НЕ ДОСТУПИТЬ секретов в открытом виде; хранение секретов вне кода
- НЕ выводить сырые данные в консоль в рабочем режиме
- НЕ использовать синхронные сетевые вызовы в главном цикле
- НЕ оборачивать конфигурационные файлы в скрипты напрямую
- НЕ менять версии или пути во время реконструкции артефакта

## 7. Verification & Testing (Верификация)

### Герхин сценарии

```gherkin
Feature: Codex Front-end Navigation
  Scenario: Successful загрузка и отображение кодекса
    Given страница загружена и индекс индикатор INDEX_DATA получен успешно
    When пользователь выбирает квест через URL параметр id или кликом открывается цельный квест
    Then отображаются зал Codex с частями, свитками и карточками квестов, в активном квесте видна детальная карта

  Scenario: Обработка ошибки при отсутствии квеста
    Given запрос к quests/quest_999.json возвращает 404
    When попытка призвать квест завершается
    Then на алтаре появляется уведомление об ошибке загрузки квеста и экран остаётся понятным
```

Артефакт app.js готов к внесению в Великую Книгу Кодекса как полноценный Ритуал Воплощения Знаний: он соединяет Эфир Kodex через INDEX_DATA, заполняет залы и обеспечивает плавный путь между Свитками квестов, превращая данные во взаимодействующий мир.
