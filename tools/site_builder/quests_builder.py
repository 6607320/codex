"""–í–µ–ª–∏–∫–∏–π –ì—Ä–∏–º—É–∞—Ä: –°–±–æ—Ä—â–∏–∫ –°–∞–π—Ç–∞ (generate.py)

–≠—Ç–æ—Ç –ø–µ—Ä–≥–∞–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –¥–ª—è –†–∏—Ç—É–∞–ª–∞ 2: "–°–±–æ—Ä–∫–∞ –§–∏–Ω–∞–ª—å–Ω–æ–π –°—Ç—Ä–∞–Ω–∏—Ü—ã".
–ï–≥–æ –≥–ª–∞–≤–Ω–∞—è –º–∏—Å—Å–∏—è ‚Äî —Å–æ–±—Ä–∞—Ç—å –≤–æ–µ–¥–∏–Ω–æ –≤—Å–µ —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã
(CODEX.md, manifest.md, scenarios/*.json) –∏ –≤—ã–∫–æ–≤–∞—Ç—å –∏–∑ –Ω–∏—Ö –µ–¥–∏–Ω—ã–µ,
–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (`static/quests/*.json`), –≥–æ—Ç–æ–≤—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
–Ω–∞ —Å–∞–π—Ç–µ –ö–æ–¥–µ–∫—Å–∞.

–ö–ª—é—á–µ–≤–∞—è –º–∞–≥–∏—è —ç—Ç–æ–≥–æ –≥—Ä–∏–º—É–∞—Ä–∞ ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ "–•–µ—à–∞—Ö
–°–±–æ—Ä–∫–∏". –ü—Ä–µ–∂–¥–µ —á–µ–º –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è —Å–∞–π—Ç–∞, —Å–∫—Ä–∏–ø—Ç –≤—ã—á–∏—Å–ª—è–µ—Ç
—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –≤—Å–µ—Ö –µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤. –ï—Å–ª–∏ —ç—Ç–æ—Ç –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å
—Ç–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å–∞–Ω –≤ "–ö—ç—à–µ –°–±–æ—Ä–∫–∏" (`build_cache.json`), —Ä–∏—Ç—É–∞–ª –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç
—ç—Ç–æ—Ç –∫–≤–µ—Å—Ç, —ç–∫–æ–Ω–æ–º—è –≤—Ä–µ–º—è –∏ —Ä–µ—Å—É—Ä—Å—ã —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.
"""

# --- –ê–∫—Ç 1: –ü—Ä–∏–∑—ã–≤ –í–µ–ª–∏–∫–∏—Ö –ì—Ä–∏–º—É–∞—Ä–æ–≤ ---
# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'os' –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏ –ø—É—Ç—è–º–∏.
import os

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'json' –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ —Å–≤–∏—Ç–∫–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
import json

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 're' (Regular Expressions) –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∞–π–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –≤ —Ç–µ–∫—Å—Ç–∞—Ö.
import re

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'markdown' –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è
# —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ä—É–Ω Markdown –≤ HTML-–∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è.
import markdown

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'textwrap' –¥–ª—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.
import textwrap

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'hashlib' –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö "–º–∞–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥–ø–∏—Å–µ–π" (—Ö–µ—à–µ–π).
import hashlib

# --- –ê–∫—Ç 2: –ù–∞—á–µ—Ä—Ç–∞–Ω–∏–µ –ö–∞—Ä—Ç—ã –ú–∏—Ä–∞ (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è) ---
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É –ø–µ—Ä–≥–∞–º–µ–Ω—Ç—É (—ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç—É).
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
# –ú—ã –≤—ã—á–∏—Å–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –≤—Å–µ–π –Ω–∞—à–µ–π –¶–∏—Ç–∞–¥–µ–ª–∏ (–ø—Ä–æ–µ–∫—Ç–∞),
# –ø–æ–¥–Ω–∏–º–∞—è—Å—å –Ω–∞ –¥–≤–∞ —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö.
PROJECT_ROOT = os.path.abspath(os.path.join(SCRIPT_DIR, "../../"))
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –•—Ä–∞–Ω–∏–ª–∏—â—É 'static',
# –≥–¥–µ –±—É–¥—É—Ç –ª–µ–∂–∞—Ç—å –≤—Å–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–∞–π—Ç–∞.
OUTPUT_DIR = os.path.join(SCRIPT_DIR, "static")
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ, –≥–¥–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–≤–µ—Å—Ç—É.
QUESTS_DIR = os.path.join(OUTPUT_DIR, "quests")
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É-–∏–Ω–¥–µ–∫—Å—É, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∞—Ç–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞.
INDEX_FILE = os.path.join(OUTPUT_DIR, "index.json")
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É-–∫—ç—à—É, —Ö—Ä–∞–Ω—è—â–µ–º—É "–ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ü–æ–¥–ø–∏—Å–∏" —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤.
CACHE_FILE = os.path.join(OUTPUT_DIR, "build_cache.json")
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –•—Ä–∞–Ω–∏–ª–∏—â—É –°—Ü–µ–Ω–∞—Ä–∏–µ–≤, –æ—Ç–∫—É–¥–∞ –±—É–¥–µ–º –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.
SCENARIOS_DIR = os.path.join(SCRIPT_DIR, "static", "scenarios")

# –ú—ã –æ–≥–ª–∞—à–∞–µ–º –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª (–∫–æ–Ω—Å–æ–ª—å) –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
print(f"üìÇ –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: {PROJECT_ROOT}")

# --- –ê–∫—Ç 3: –ß–µ—Ä—Ç–µ–∂–∏ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –†–∏—Ç—É–∞–ª–æ–≤ ---


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è "–ú–∞–≥–∏—á–µ—Å–∫–æ–π –ü–æ–¥–ø–∏—Å–∏".
def calculate_hash(content):
    # –ú—ã –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ "–ê–ª—Ö–∏–º–∏—á–µ—Å–∫–∏–π –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å" (MD5)
    # –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫.
    return hashlib.md5(content.encode("utf-8")).hexdigest()


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ "–ö—ç—à–∞ –°–±–æ—Ä–∫–∏".
def load_cache():
    # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ —Ñ–∞–π–ª –∫—ç—à–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç...
    if os.path.exists(CACHE_FILE):
        # ...–º—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ –¥–ª—è —á—Ç–µ–Ω–∏—è...
        with open(CACHE_FILE, "r", encoding="utf-8") as f:
            # ...–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–Ω–æ–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±—ä–µ–∫—Ç Python.
            return json.load(f)
    # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –∫—ç—à–∞ –Ω–µ—Ç, –º—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é "—Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü—É" (—Å–ª–æ–≤–∞—Ä—å).
    return {}


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è "–ö—ç—à–∞ –°–±–æ—Ä–∫–∏".
def save_cache(cache):
    # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –∫—ç—à–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏...
    with open(CACHE_FILE, "w", encoding="utf-8") as f:
        # ...–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–µ–≥–æ –Ω–∞—à –æ–±—ä–µ–∫—Ç Python –≤ –∫—Ä–∞—Å–∏–≤–æ–º, —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        json.dump(cache, f, indent=2)


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –í–µ–ª–∏–∫–æ–π –õ–µ—Ç–æ–ø–∏—Å–∏.
def parse_codex():
    # –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –í–µ–ª–∏–∫–æ–π –õ–µ—Ç–æ–ø–∏—Å–∏ 'CODEX.md'.
    codex_path = os.path.join(PROJECT_ROOT, "CODEX.md")
    # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –õ–µ—Ç–æ–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞...
    if not os.path.exists(codex_path):
        # ...–º—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∫–≤–µ—Å—Ç–æ–≤.
        return []
    # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –õ–µ—Ç–æ–ø–∏—Å—å –¥–ª—è —á—Ç–µ–Ω–∏—è.
    with open(codex_path, "r", encoding="utf-8") as f:
        # –ú—ã —á–∏—Ç–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –õ–µ—Ç–æ–ø–∏—Å–∏ –≤ —Å–ø–∏—Å–æ–∫.
        lines = f.readlines()

    # –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–≤–µ—Å—Ç–∞—Ö.
    quests = []
    # –ú—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞.
    current_quest, capture_comment, comment_buffer = None, False, []
    # –ú—ã –∑–∞–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏–∏ –ö–æ–¥–µ–∫—Å–∞ (–Ω–∞ —Å–ª—É—á–∞–π,
    # –µ—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–∞—á–Ω–µ—Ç—Å—è –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞).
    current_part_num, current_part_title, current_scroll_title = (
        "0",  # –ù–æ–º–µ—Ä –ß–∞—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
        "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ß–∞—Å—Ç—å",  # –ù–∞–∑–≤–∞–Ω–∏–µ –ß–∞—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
        "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –°–≤–∏—Ç–æ–∫",  # –ù–∞–∑–≤–∞–Ω–∏–µ –°–≤–∏—Ç–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    )

    # –ú—ã —Å–æ–∑–¥–∞–µ–º "–º–∞–≥–∏—á–µ—Å–∫–∏–µ —à–∞–±–ª–æ–Ω—ã" (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è) –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    # –≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏—â–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Ä–æ–≤–Ω—è ## —Å —Ç–µ–∫—Å—Ç–æ–º "–ß–∞—Å—Ç—å X: –ù–∞–∑–≤–∞–Ω–∏–µ".
    part_pattern = re.compile(r"##\s+\*\*–ß–∞—Å—Ç—å\s+(\d+):\s*(.*?)\*\*")
    # –≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏—â–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Ä–æ–≤–Ω—è ###.
    subheader_pattern = re.compile(r"^\s*###\s+")
    # –≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏—â–µ—Ç —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "- –ö–≤–µ—Å—Ç X.X: –ù–∞–∑–≤–∞–Ω–∏–µ".
    quest_pattern = re.compile(r"-\s+(?:\[.?\]\s+)?–ö–≤–µ—Å—Ç\s+(\d+\.\d+):\s*(.*)")

    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –≤–µ–ª–∏–∫–∏–π —Ü–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—è –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –õ–µ—Ç–æ–ø–∏—Å–∏.
    for line in lines:
        # –ú—ã –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ß–∞—Å—Ç–∏".
        part_match = part_pattern.search(line)
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏...
        if part_match:
            # ...–º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –ß–∞—Å—Ç–∏ –∏–∑ –ø–µ—Ä–≤–æ–π –≥—Ä—É–ø–ø—ã
            # –Ω–∞—à–µ–≥–æ —à–∞–±–ª–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1").
            current_part_num = part_match.group(1)
            # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∏—Ç—É–∞–ª –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π 'current_part_title',
            # –æ—Ç–∫—Ä—ã–≤–∞—è —Å–∫–æ–±–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∏—Ç–∞–µ–º–æ–≥–æ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.
            current_part_title = (
                # –ú—ã —Å–æ—Ç–≤–æ—Ä—è–µ–º –º–∞–≥–∏—á–µ—Å–∫—É—é f-—Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–µ–¥–∏–Ω—è–µ—Ç: —Ç–µ–∫—Å—Ç '–ß–∞—Å—Ç—å ',
                # –Ω–æ–º–µ—Ä (`current_part_num`), –¥–≤–æ–µ—Ç–æ—á–∏–µ, –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ß–∞—Å—Ç–∏ (–∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–µ
                # –∏–∑ –≤—Ç–æ—Ä–æ–π –≥—Ä—É–ø–ø—ã —à–∞–±–ª–æ–Ω–∞ –∏ –æ—á–∏—â–µ–Ω–Ω–æ–µ –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ –∫—Ä–∞—è–º).
                f"–ß–∞—Å—Ç—å {current_part_num}: {part_match.group(2).strip()}"
            )
            # –ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ, –ø—Ä–æ–ø—É—Å–∫–∞—è –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.
            continue

        # –ú—ã –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–°–≤–∏—Ç–∫–∞" (–ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫).
        if subheader_pattern.search(line):
            # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º "—Å—ã—Ä–æ–π" —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞, —É–±–∏—Ä–∞—è —Å–∏–º–≤–æ–ª—ã Markdown.
            raw_title = line.strip().replace("###", "").replace("**", "").strip()
            # –ú—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –µ–≥–æ –æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–∞—Ç—É—Å–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä,
            # "(–°—Ç–∞—Ç—É—Å: –û—Å–≤–æ–µ–Ω)").
            current_scroll_title = re.sub(r"\s*\(–°—Ç–∞—Ç—É—Å:.*?\)", "", raw_title).strip()
            # –ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ.
            continue

        # –ú—ã –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ö–≤–µ—Å—Ç–∞".
        quest_match = quest_pattern.search(line)
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏...
        if quest_match:
            # ...–º—ã —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–≤–µ—Å—Ç, –µ—Å–ª–∏ –æ–Ω –±—ã–ª.
            if current_quest:
                # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–≤–µ—Å—Ç–∞ –≤ –Ω–∞—à –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫.
                quests.append(current_quest)
            # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º ID –Ω–æ–≤–æ–≥–æ –∫–≤–µ—Å—Ç–∞...
            q_id = quest_match.group(1)
            # ...–∏ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ—á–∏—â–∞—è –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∫–æ–Ω—Ü–µ.
            q_title = re.sub(r"\s*`?\[.*?\]`?$", "", quest_match.group(2)).strip()
            # –ú—ã —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç-—Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–≤–µ—Å—Ç–∞ —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
            current_quest = {
                # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (ID) –∫–≤–µ—Å—Ç–∞.
                "id": q_id,
                # –ï–≥–æ –ø—Ä–æ–≤–æ–∑–≥–ª–∞—à–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.
                "title": q_title,
                # –ù–æ–º–µ—Ä –ß–∞—Å—Ç–∏, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç.
                "partNumber": current_part_num,
                # –ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ß–∞—Å—Ç–∏.
                "partTitle": current_part_title,
                # –ù–∞–∑–≤–∞–Ω–∏–µ –°–≤–∏—Ç–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è.
                "scrollTitle": current_scroll_title,
                # –ü—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –±—É–¥—É—â–µ–π –õ–µ–≥–µ–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.
                "legend_md": "",
                # –ü—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –±—É–¥—É—â–µ–π –õ–µ–≥–µ–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML.
                "legend_html": "",
                # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ú–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω –Ω–µ –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω.
                "manifest_html": "<em>–°–≤–∏—Ç–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω...</em>",
                # –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–≤–µ—Å—Ç–∞ - "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω".
                "status": "locked",
            }
            # –ú—ã —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–±–æ—Ä–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
            capture_comment, comment_buffer = False, []
            # –ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ.
            continue

        # –ï—Å–ª–∏ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –∫–≤–µ—Å—Ç–∞...
        if current_quest:
            # ...–º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å –ª–∏ —Å–µ–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
            if "<!--" in line:
                # –ï—Å–ª–∏ –¥–∞, –º—ã –ø–æ–¥–Ω–∏–º–∞–µ–º "—Ñ–ª–∞–≥ –∑–∞—Ö–≤–∞—Ç–∞".
                capture_comment = True
            # –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–Ω—è—Ç –ª–∏ "—Ñ–ª–∞–≥ –∑–∞—Ö–≤–∞—Ç–∞"
            # (—Ç–æ –µ—Å—Ç—å, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è).
            if capture_comment:
                # –ï—Å–ª–∏ —Ñ–ª–∞–≥ –ø–æ–¥–Ω—è—Ç, –º—ã –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                # –≤ –Ω–∞—à –±—É—Ñ–µ—Ä –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–±–æ—Ä–∫–∏.
                comment_buffer.append(line)
            # –ï—Å–ª–∏ –º—ã –Ω–∞—à–ª–∏ –∫–æ–Ω–µ—Ü –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ "—Ñ–ª–∞–≥ –∑–∞—Ö–≤–∞—Ç–∞" –≤—Å–µ –µ—â–µ –ø–æ–¥–Ω—è—Ç...
            if "-->" in line and capture_comment:
                # ...–º—ã –æ–ø—É—Å–∫–∞–µ–º "—Ñ–ª–∞–≥ –∑–∞—Ö–≤–∞—Ç–∞".
                capture_comment = False
                # –ú—ã –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ –æ–¥–∏–Ω —Å–ø–ª–æ—à–Ω–æ–π —Ç–µ–∫—Å—Ç.
                full = "".join(comment_buffer)
                # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ç–µ–≥–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
                match = re.search(r"<!--(.*?)-->", full, re.DOTALL)
                # –ï—Å–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —É–¥–∞–ª–æ—Å—å...
                if match:
                    # ...–º—ã –æ—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤...
                    raw = textwrap.dedent(match.group(1))
                    # ...–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ Markdown-–≤–µ—Ä—Å–∏–∏...
                    current_quest["legend_md"] = raw
                    # ...–∏ –≤ HTML-–≤–µ—Ä—Å–∏–∏.
                    current_quest["legend_html"] = markdown.markdown(raw)
                # –ú—ã –æ—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–≤–µ—Å—Ç–∞.
                comment_buffer = []
    # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–∏–∫–ª–∞ –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–≤–µ—Å—Ç.
    if current_quest:
        # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –Ω–∞—à –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫.
        quests.append(current_quest)
    # –ú—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–≤–µ—Å—Ç–æ–≤.
    return quests


# –ß–µ—Ä—Ç–µ–∂ –≥–ª–∞–≤–Ω–æ–≥–æ —Ä–∏—Ç—É–∞–ª–∞ —Å–±–æ—Ä–∫–∏ —Å–∞–π—Ç–∞.
def build():
    # "–°—Ç—Ä–∞–∂-–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä": –º—ã —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–∞–π—Ç–∞, –µ—Å–ª–∏ –µ–µ –µ—â–µ –Ω–µ—Ç.
    if not os.path.exists(OUTPUT_DIR):
        # –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏.
        os.makedirs(OUTPUT_DIR)
    # "–°—Ç—Ä–∞–∂-–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä": –º—ã —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤, –µ—Å–ª–∏ –µ–µ –µ—â–µ –Ω–µ—Ç.
    if not os.path.exists(QUESTS_DIR):
        # –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏.
        os.makedirs(QUESTS_DIR)
    # "–°—Ç—Ä–∞–∂-–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä": –º—ã —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –µ—Å–ª–∏ –µ–µ –µ—â–µ –Ω–µ—Ç.
    if not os.path.exists(SCENARIOS_DIR):
        # –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏.
        os.makedirs(SCENARIOS_DIR)

    # –ú—ã –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à –∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –Ω–æ–≤–æ–≥–æ.
    cache, new_cache = load_cache(), {}
    # –ú—ã –ø–∞—Ä—Å–∏–º 'CODEX.md' –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–≤–µ—Å—Ç–æ–≤.
    quests_list = parse_codex()
    # –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–∞ –∏ —Å—á–µ—Ç—á–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.
    index_data, updated_count = [], 0

    # –ú—ã —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É, —Å–≤—è–∑—ã–≤–∞—é—â—É—é ID –∫–≤–µ—Å—Ç–æ–≤ —Å –∏—Ö –ø—É—Ç—è–º–∏ –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ.
    quest_fs_map = {}
    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–í–µ–ª–∏–∫–∏–π –û–±—Ö–æ–¥" –ø–æ –≤—Å–µ–º –ø–∞–ø–∫–∞–º –∏ —Ñ–∞–π–ª–∞–º –Ω–∞—à–µ–π –¶–∏—Ç–∞–¥–µ–ª–∏.
    for root, _, _ in os.walk(PROJECT_ROOT):
        # –ú—ã –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–∞–ø–∫–∏ ('site_builder', '.git', '.dvc'),
        # —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –∑—Ä—è.
        if any(d in root for d in ["site_builder", ".git", ".dvc"]):
            # –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏".
            continue
        # –ú—ã –∏—â–µ–º –ø–∞–ø–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ä–º–∞—Ç—É –∫–≤–µ—Å—Ç–æ–≤ (Scroll_X/Quest_Y).
        match = re.search(r"Scroll_(\d+)[\\/]Quest_(\d+)", root)
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∏ –≤ –ø–∞–ø–∫–µ –µ—Å—Ç—å 'manifest.md'...
        if match and "MANIFEST.md" in os.listdir(root):
            # ...–º—ã —Å–æ–∑–¥–∞–µ–º ID –∫–≤–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1.2")...
            q_id = f"{int(match.group(1))}.{int(match.group(2))}"
            # ...–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ –∫–∞—Ä—Ç—É –≤–º–µ—Å—Ç–µ —Å –ø—É—Ç–µ–º –∫ –ø–∞–ø–∫–µ.
            quest_fs_map[q_id] = root

    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –≤–µ–ª–∏–∫–∏–π —Ü–∏–∫–ª, –ø—Ä–æ—Ö–æ–¥—è –ø–æ –∫–∞–∂–¥–æ–º—É –∫–≤–µ—Å—Ç—É –∏–∑ –Ω–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞.
    for quest in quests_list:
        # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –∫–≤–µ—Å—Ç–∞.
        q_id = quest["id"]
        # –ú—ã –Ω–∞—Ö–æ–¥–∏–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ.
        quest_folder = quest_fs_map.get(q_id)
        # –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ú–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –∏ –°—Ü–µ–Ω–∞—Ä–∏—è.
        manifest_content, scenario_data = "", []

        # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –∫–≤–µ—Å—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞...
        if quest_folder:
            # ...–º—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ –µ–≥–æ 'manifest.md'.
            manifest_path = os.path.join(quest_folder, "MANIFEST.md")
            # –ï—Å–ª–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç...
            if os.path.exists(manifest_path):
                # ...–º—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ –¥–ª—è —á—Ç–µ–Ω–∏—è...
                with open(manifest_path, "r", encoding="utf-8") as f:
                    # ...–∏ —Å—á–∏—Ç—ã–≤–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.
                    manifest_content = f.read()
                # –ú—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –≤ HTML...
                quest["manifest_html"] = markdown.markdown(
                    # ...–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏–≤ –æ—Ç –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤...
                    textwrap.dedent(manifest_content),
                    # ...–∏ –≤–∫–ª—é—á–∏–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –∫–æ–¥–∞ –∏ —Ç–∞–±–ª–∏—Ü.
                    extensions=["fenced_code", "tables"],
                )
                # –ú—ã –ø–æ–º–µ—á–∞–µ–º –∫–≤–µ—Å—Ç –∫–∞–∫ '–∞–∫—Ç–∏–≤–Ω—ã–π'.
                quest["status"] = "active"

            # –ú—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
            scenario_file = os.path.join(SCENARIOS_DIR, f"quest_{q_id}.json")
            # –ï—Å–ª–∏ —Ñ–∞–π–ª —Å—Ü–µ–Ω–∞—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç...
            if os.path.exists(scenario_file):
                # ...–º—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã" –æ—Ç –æ—à–∏–±–æ–∫ —á—Ç–µ–Ω–∏—è.
                try:
                    # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏ —á–∏—Ç–∞–µ–º –µ–≥–æ.
                    with open(scenario_file, "r", encoding="utf-8") as f:
                        # –ú—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±—ä–µ–∫—Ç Python.
                        raw_scenario = json.load(f)

                        # –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω –Ω–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
                        #  —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏.
                        if (
                            isinstance(raw_scenario, dict)
                            and "scenario" in raw_scenario
                        ):
                            # –ï—Å–ª–∏ –¥–∞, –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Å—Å–∏–≤ —Å—Ü–µ–Ω–∞—Ä–∏—è.
                            scenario_data = raw_scenario["scenario"]
                        # –ï—Å–ª–∏ –∂–µ —ç—Ç–æ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫)...
                        elif isinstance(raw_scenario, list):
                            # ...–º—ã –±–µ—Ä–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å.
                            scenario_data = raw_scenario
                # –ï—Å–ª–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∏—Ç—ã–π JSON)...
                except Exception:
                    # ...–º—ã —Å–æ–æ–±—â–∞–µ–º –ú–∞–≥—É –æ–± –æ—à–∏–±–∫–µ...
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è {q_id}")
                    # ...–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã —Å–±–æ—Ä–∫–∞ –Ω–µ —É–ø–∞–ª–∞.
                    scenario_data = []

            # –ú—ã —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã,
            #  –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É.
            data_to_hash = (
                # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–≤–µ—Å—Ç–∞.
                quest["title"]
                # –ï–≥–æ –ª–µ–≥–µ–Ω–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.
                + quest["legend_md"]
                # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –µ–≥–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.
                + manifest_content
                # –ò –µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ –≤–∏–¥–µ JSON-—Å—Ç—Ä–æ–∫–∏.
                + json.dumps(scenario_data)
            )
            # –ú—ã –≤—ã—á–∏—Å–ª—è–µ–º "–•–µ—à –°–±–æ—Ä–∫–∏" –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–≤–µ—Å—Ç–∞.
            current_hash = calculate_hash(data_to_hash)
            # –ú—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —ç—Ç–æ—Ç —Ö–µ—à –≤ –Ω–æ–≤—ã–π –∫—ç—à.
            new_cache[q_id] = current_hash
            # –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å, –∫—É–¥–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è —Å–∞–π—Ç–∞.
            json_path = os.path.join(QUESTS_DIR, f"quest_{q_id}.json")

            # "–°—Ç—Ä–∞–∂ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –°–±–æ—Ä–∫–∏":
            # –µ—Å–ª–∏ —Ö–µ—à –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ –Ω–µ—Ç...
            if cache.get(q_id) != current_hash or not os.path.exists(json_path):
                # ...–º—ã —Å–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞...
                full_quest_data = {
                    # ID –∫–≤–µ—Å—Ç–∞.
                    "id": quest["id"],
                    # –ï–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ.
                    "title": quest["title"],
                    # –õ–µ–≥–µ–Ω–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML.
                    "legend": quest["legend_html"],
                    # –ú–∞–Ω–∏—Ñ–µ—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML.
                    "manifest": quest["manifest_html"],
                    # –°—Ç–∞—Ç—É—Å (–∞–∫—Ç–∏–≤–µ–Ω/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω).
                    "status": quest["status"],
                    # –î–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.
                    "scenario": scenario_data,
                }
                # ...–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏ —ç—Ç–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞...
                with open(json_path, "w", encoding="utf-8") as f:
                    # ...–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –Ω–∞ –¥–∏—Å–∫ –≤ –∫—Ä–∞—Å–∏–≤–æ–º, —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
                    json.dump(full_quest_data, f, ensure_ascii=False, indent=2)
                # –ú—ã —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤.
                updated_count += 1

            # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–≤–µ—Å—Ç–µ –≤ –æ–±—â–∏–π –∏–Ω–¥–µ–∫—Å —Å–∞–π—Ç–∞.
            index_data.append(
                {
                    # ID –∫–≤–µ—Å—Ç–∞.
                    "id": quest["id"],
                    # –ï–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ.
                    "title": quest["title"],
                    # –ù–æ–º–µ—Ä –ß–∞—Å—Ç–∏.
                    "partNumber": quest["partNumber"],
                    # –ù–∞–∑–≤–∞–Ω–∏–µ –ß–∞—Å—Ç–∏.
                    "partTitle": quest["partTitle"],
                    # –ù–∞–∑–≤–∞–Ω–∏–µ –°–≤–∏—Ç–∫–∞.
                    "scrollTitle": quest["scrollTitle"],
                    # –°—Ç–∞—Ç—É—Å.
                    "status": quest["status"],
                }
            )

    # –ú—ã —Å–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ñ–∞–π–ª–∞-–∏–Ω–¥–µ–∫—Å–∞.
    final_index = {"quests": index_data}
    # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª-–∏–Ω–¥–µ–∫—Å –¥–ª—è –∑–∞–ø–∏—Å–∏...
    with open(INDEX_FILE, "w", encoding="utf-8") as f:
        # ...–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –Ω–∞ –¥–∏—Å–∫ –≤ –∫—Ä–∞—Å–∏–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        json.dump(final_index, f, ensure_ascii=False, indent=2)
    # –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π "–ö—ç—à –°–±–æ—Ä–∫–∏".
    save_cache(new_cache)
    # –ú—ã –æ–≥–ª–∞—à–∞–µ–º –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ.
    print(f"‚ú® –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±–Ω–æ–≤–ª–µ–Ω–æ –∫–≤–µ—Å—Ç–æ–≤: {updated_count}")


# "–°–≤—è—â–µ–Ω–Ω–æ–µ –ù–∞—á–∞–ª–æ". –≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞,
# –∫–æ–≥–¥–∞ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é.
if __name__ == "__main__":
    # –ú—ã –∑–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª —Å–±–æ—Ä–∫–∏.
    build()
