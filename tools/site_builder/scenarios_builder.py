"""–í–µ–ª–∏–∫–∏–π –ì—Ä–∏–º—É–∞—Ä: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ (ai_openrouter.py)

–≠—Ç–æ—Ç –ø–µ—Ä–≥–∞–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –¥–ª—è –†–∏—Ç—É–∞–ª–∞ 1: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ò—Å—Ö–æ–¥–Ω–æ–≥–æ –°—Ü–µ–Ω–∞—Ä–∏—è". –ï–≥–æ
–≥–ª–∞–≤–Ω–∞—è –º–∏—Å—Å–∏—è ‚Äî –æ–±—â–∞—Ç—å—Å—è —Å –º–æ–≥—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –û—Ä–∞–∫—É–ª–æ–º (LLM), —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ
–õ–µ–≥–µ–Ω–¥—ã –∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∫–≤–µ—Å—Ç–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON-—Å—Ü–µ–Ω–∞—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–∏—Ç–∏—Ä—É—é—Ç
–¥–∏–∞–ª–æ–≥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.

–ö–ª—é—á–µ–≤–∞—è –º–∞–≥–∏—è —ç—Ç–æ–≥–æ –≥—Ä–∏–º—É–∞—Ä–∞ ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ "–ú–∞–≥–∏—á–µ—Å–∫–∏—Ö
–ü–æ–¥–ø–∏—Å—è—Ö" (—Ö–µ—à–∞—Ö). –ü—Ä–µ–∂–¥–µ —á–µ–º —Ç—Ä–∞—Ç–∏—Ç—å –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—É—é –º–∞–Ω—É (—Ç–æ–∫–µ–Ω—ã API) –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫
–û—Ä–∞–∫—É–ª—É, —Å–∫—Ä–∏–ø—Ç –≤—ã—á–∏—Å–ª—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–õ–µ–≥–µ–Ω–¥–∞ + –ö–æ–¥). –ï—Å–ª–∏ —ç—Ç–æ—Ç
–æ—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ —É–∂–µ –∑–∞–ø–µ—á–∞—Ç–∞–Ω –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏, —Ä–∏—Ç—É–∞–ª
–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, —ç–∫–æ–Ω–æ–º—è –≤—Ä–µ–º—è –∏ —Ä–µ—Å—É—Ä—Å—ã.
"""

# --- –ê–∫—Ç 1: –ü—Ä–∏–∑—ã–≤ –í–µ–ª–∏–∫–∏—Ö –ì—Ä–∏–º—É–∞—Ä–æ–≤ ---
# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'os' –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏ –ø—É—Ç—è–º–∏.
import os

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'json' –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ —Å–≤–∏—Ç–∫–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
import json

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 're' (Regular Expressions) –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∞–π–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –≤ —Ç–µ–∫—Å—Ç–∞—Ö.
import re

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'glob' –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç–æ–≤ –ø–æ —à–∞–±–ª–æ–Ω–∞–º.
import glob

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –≥—Ä–∏–º—É–∞—Ä 'hashlib' –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö "–º–∞–≥–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥–ø–∏—Å–µ–π" (—Ö–µ—à–µ–π).
import hashlib

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –¥—É—Ö–∞ –í—Ä–µ–º–µ–Ω–∏ 'time' –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ –ø–∞—É–∑–∞–º–∏ –∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏.
import time

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º "–î—É—Ö–∞-–ü–æ—Å—Ä–µ–¥–Ω–∏–∫–∞" –∏–∑ –≥—Ä–∏–º—É–∞—Ä–∞ 'openai' –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –û—Ä–∞–∫—É–ª–æ–º.
from openai import OpenAI

# –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ 'load_dotenv' –¥–ª—è —á—Ç–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö —Ä—É–Ω –∏–∑ —Ñ–∞–π–ª–∞ '.env'.
from dotenv import load_dotenv

# –ú—ã —Å–æ—Ç–≤–æ—Ä—è–µ–º "–ö—Ä–∏—Å—Ç–∞–ª–ª –ü–∞–º—è—Ç–∏", –≥–¥–µ –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –û—Ä–∞–∫—É–ª–∞,
# –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –Ω–∞—à –∑–æ–≤. –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –æ–Ω –ø—É—Å—Ç.
LAST_SUCCESSFUL_MODEL = None

# --- –ê–∫—Ç 2: –ù–∞—á–µ—Ä—Ç–∞–Ω–∏–µ –ö–∞—Ä—Ç—ã –ú–∏—Ä–∞ (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è) ---
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É –ø–µ—Ä–≥–∞–º–µ–Ω—Ç—É (—ç—Ç–æ–º—É —Å–∫—Ä–∏–ø—Ç—É).
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
# –ú—ã –≤—ã—á–∏—Å–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –≤—Å–µ–π –Ω–∞—à–µ–π –¶–∏—Ç–∞–¥–µ–ª–∏ (–ø—Ä–æ–µ–∫—Ç–∞),
# –ø–æ–¥–Ω–∏–º–∞—è—Å—å –Ω–∞ –¥–≤–∞ —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö.
PROJECT_ROOT = os.path.abspath(os.path.join(BASE_DIR, "../../"))
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –•—Ä–∞–Ω–∏–ª–∏—â—É –°—Ü–µ–Ω–∞—Ä–∏–µ–≤, –≥–¥–µ –±—É–¥—É—Ç –ª–µ–∂–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —ç—Ç–æ–≥–æ —Ä–∏—Ç—É–∞–ª–∞.
SCENARIOS_DIR = os.path.join(BASE_DIR, "static", "scenarios")
# –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –í–µ–ª–∏–∫–æ–π –õ–µ—Ç–æ–ø–∏—Å–∏, –Ω–∞—à–µ–º—É –≥–ª–∞–≤–Ω–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É –º—É–¥—Ä–æ—Å—Ç–∏.
CODEX_FILE = os.path.join(PROJECT_ROOT, "CODEX.md")

# –ú—ã –ø—Ä–æ–∏–∑–Ω–æ—Å–∏–º –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∏—â–µ—Ç '.env' —Ñ–∞–π–ª –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ
# –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ —Å–µ–∫—Ä–µ—Ç—ã.
load_dotenv(os.path.join(BASE_DIR, ".env"))

# –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ö–ª—é—á" –¥–ª—è –û—Ä–∞–∫—É–ª–∞ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è,
# –∫—É–¥–∞ –µ–≥–æ –ø–æ–º–µ—Å—Ç–∏–ª 'load_dotenv'.
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
# –ú—ã –≤–æ–ø—Ä–æ—à–∞–µ–º –¢–∞–π–Ω—ã–µ –°–≤–∏—Ç–∫–∏ –û–∫—Ä—É–∂–µ–Ω–∏—è,
# –¥–∞–±—ã —É–∑—Ä–µ—Ç—å –∏—Å—Ç–∏–Ω–Ω—ã–π –ø—É—Ç—å –∫ –ü–æ—Ä—Ç–∞–ª—É –í–µ–ª–∏–∫–æ–≥–æ –û—Ä–∞–∫—É–ª–∞ (OpenRouter).
OPENROUTER_BASE_URL = os.getenv("OPENROUTER_BASE_URL")
# "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω...
if not OPENROUTER_API_KEY:
    # ...–º—ã –ø–æ–¥–Ω–∏–º–∞–µ–º —Ç—Ä–µ–≤–æ–≥—É, –ø—Ä–µ—Ä—ã–≤–∞—è —Ä–∏—Ç—É–∞–ª –∏ —Å–æ–æ–±—â–∞—è –ú–∞–≥—É, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.
    raise ValueError(
        "‚ùå –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω –∫–ª—é—á. –°–æ–∑–¥–∞–π .env –≤ –ø–∞–ø–∫–µ tools/site_builder/"
    )
# –ú—ã –≤–æ–ø—Ä–æ—à–∞–µ–º –≠—Ñ–∏—Ä –û–∫—Ä—É–∂–µ–Ω–∏—è, –¥–∞–±—ã –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–µ–≥–æ –ø–µ—Ä–µ—á–µ–Ω—å –∏–º–µ–Ω –í–µ–ª–∏–∫–∏—Ö –ú–æ–¥–µ–ª–µ–π.
models_raw = os.getenv("MODELS_LIST")

# –ö–æ–ª–∏ –∑–Ω–∞–º–µ–Ω–∏—è –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã –∏ —Å–≤–∏—Ç–æ–∫ —Å –∏–º–µ–Ω–∞–º–∏ –Ω–µ –æ–∫–∞–∑–∞–ª—Å—è –ø—É—Å—Ç...
if models_raw:
    # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    MODELS = [m.strip() for m in models_raw.split(",")]
# –ù–æ –µ—Å–ª–∏ –º—Ä–∞–∫ –±–µ–∑–º–æ–ª–≤–∏—è –ø–æ–≥–ª–æ—Ç–∏–ª –Ω–∞—à –∑–∞–ø—Ä–æ—Å –∏ –Ω–∏ –æ–¥–Ω–æ –∏–º—è –Ω–µ –±—ã–ª–æ —è–≤–ª–µ–Ω–æ –∏–∑ –ü—É—Å—Ç–æ—Ç—ã...
else:
    # –°–ø–∏—Å–æ–∫ –û—Ä–∞–∫—É–ª–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (Top-19 Safe Models).
    MODELS = [
        "openai/gpt-5-nano",
    ]

# "–°—Ç—Ä–∞–∂-–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä": –µ—Å–ª–∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç...
if not os.path.exists(SCENARIOS_DIR):
    # ...–º—ã —Å–æ—Ç–≤–æ—Ä—è–µ–º –µ–≥–æ –∏–∑ –ø—É—Å—Ç–æ—Ç—ã.
    os.makedirs(SCENARIOS_DIR)

# –ú—ã —Å–æ—Ç–≤–æ—Ä—è–µ–º "–ü–æ—Å—Ä–µ–¥–Ω–∏–∫–∞" (–∫–ª–∏–µ–Ω—Ç–∞),
# —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞—à–∏ –ø–æ—Å–ª–∞–Ω–∏—è –û—Ä–∞–∫—É–ª—É.
client = OpenAI(
    # –ú—ã –Ω–∞—á–µ—Ä—Ç–∞–µ–º –Ω–∞ –∞–ª—Ç–∞—Ä–µ –ø—É—Ç—å –∫ –í—Ä–∞—Ç–∞–º –û—Ä–∞–∫—É–ª–∞, –¥–∞–±—ã –º–∞–≥–∏—á–µ—Å–∫–∏–π –≤–µ—Å—Ç–Ω–∏–∫ –∑–Ω–∞–ª,
    #  –≤ –∫–∞–∫–æ–π —á–µ—Ä—Ç–æ–≥ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –≤–∑–æ—Ä—ã.
    base_url=OPENROUTER_BASE_URL,
    # –ü—Ä–µ–¥—ä—è–≤–ª—è–µ–º –Ω–∞—à "–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ö–ª—é—á" –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    api_key=OPENROUTER_API_KEY,
)

# --- –ê–∫—Ç 3: –ß–µ—Ä—Ç–µ–∂–∏ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –†–∏—Ç—É–∞–ª–æ–≤ ---


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è "–ú–∞–≥–∏—á–µ—Å–∫–æ–π –ü–æ–¥–ø–∏—Å–∏".
def calculate_input_hash(legend, code):
    """–†–∏—Ç—É–∞–ª 1: –†–∞—Å—á–µ—Ç –í—Ö–æ–¥–Ω–æ–≥–æ –•–µ—à–∞ (–ú–∞–≥–∏—á–µ—Å–∫–∞—è –ü–æ–¥–ø–∏—Å—å)."""
    # –ú—ã —Å–ø–ª–µ—Ç–∞–µ–º –≤–æ–µ–¥–∏–Ω–æ –õ–µ–≥–µ–Ω–¥—É –∏ –ö–æ–¥ –∫–≤–µ—Å—Ç–∞.
    content = (legend + code).encode("utf-8")
    # –ú—ã –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ø–ª–µ—Ç–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ "–ê–ª—Ö–∏–º–∏—á–µ—Å–∫–∏–π –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å" (MD5)
    # –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫.
    return hashlib.md5(content).hexdigest()


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –í–µ–ª–∏–∫–æ–π –õ–µ—Ç–æ–ø–∏—Å–∏.
def parse_codex_legends():
    """–ß–∏—Ç–∞–µ—Ç CODEX.md –∏ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã –∑–∞–¥–∞–Ω–∏–π."""
    # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –õ–µ—Ç–æ–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–≤–æ–µ–º –º–µ—Å—Ç–µ...
    if not os.path.exists(CODEX_FILE):
        # ...–º—ã —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º –ú–∞–≥—É...
        print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω {CODEX_FILE}")
        # ...–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é "—Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü—É" (—Å–ª–æ–≤–∞—Ä—å).
        return {}

    # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –õ–µ—Ç–æ–ø–∏—Å—å –¥–ª—è —á—Ç–µ–Ω–∏—è,
    # —É–∫–∞–∑—ã–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫—É 'utf-8' –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä—É–Ω.
    with open(CODEX_FILE, "r", encoding="utf-8") as f:
        # –ú—ã —á–∏—Ç–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –õ–µ—Ç–æ–ø–∏—Å–∏ –≤ –µ–¥–∏–Ω—ã–π —Å–≤–∏—Ç–æ–∫-–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é.
        content = f.read()

    # –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é "—Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü—É" –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –õ–µ–≥–µ–Ω–¥.
    legends = {}
    # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–≥–∏—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π,
    # —á—Ç–æ–±—ã "—Ä–∞–∑—Ä–µ–∑–∞—Ç—å" –õ–µ—Ç–æ–ø–∏—Å—å –Ω–∞ –±–ª–æ–∫–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –ö–≤–µ—Å—Ç–æ–≤.
    quest_blocks = re.split(r"-\s+(?:\[.?\]\s+)?–ö–≤–µ—Å—Ç\s+(\d+\.\d+)", content)

    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∏—Ç—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—è –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –ø–∞—Ä–∞–º–∏
    # (ID –∫–≤–µ—Å—Ç–∞, –µ–≥–æ —Ç–µ–∫—Å—Ç).
    for i in range(1, len(quest_blocks), 2):
        # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º ID –∫–≤–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1.1").
        q_id = quest_blocks[i]
        # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫, —Å–ª–µ–¥—É—é—â–∏–π –∑–∞ ID.
        block_content = quest_blocks[i + 1]
        # –ú—ã –∏—â–µ–º –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ —Å–∫—Ä—ã—Ç—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –õ–µ–≥–µ–Ω–¥—É.
        match = re.search(r"<!--(.*?)-->", block_content, re.DOTALL)
        # –ï—Å–ª–∏ —Ç–∞–∫–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞–π–¥–µ–Ω...
        if match:
            # ...–º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –æ—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
            # –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ "—Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü—É".
            legends[q_id] = match.group(1).strip()

    # –ú—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "—Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü—É" —Å –õ–µ–≥–µ–Ω–¥–∞–º–∏, –≥–æ—Ç–æ–≤—É—é –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
    return legends


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å–±–æ—Ä–∞ –∫–æ–¥–∞ –∫–≤–µ—Å—Ç–∞.
def get_quest_code(q_id):
    """–ù–∞—Ö–æ–¥–∏—Ç –ø–∞–ø–∫—É –∫–≤–µ—Å—Ç–∞ –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –≤–µ—Å—å –∫–æ–¥."""
    # –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–∏ –∫ –ø–∞–ø–∫–µ –∫–≤–µ—Å—Ç–∞.
    target_path = None
    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã –æ—Ç –æ—à–∏–±–æ–∫", —Ç–∞–∫ –∫–∞–∫ ID –∫–≤–µ—Å—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º.
    try:
        # –ú—ã —Ä–∞–∑–¥–µ–ª—è–µ–º ID –∫–≤–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1.1") –Ω–∞ –Ω–æ–º–µ—Ä –°–≤–∏—Ç–∫–∞ –∏ –Ω–æ–º–µ—Ä –ö–≤–µ—Å—Ç–∞.
        s_num, q_num = q_id.split(".")
        # –ú—ã —Å–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞–ø–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —ç—Ç–æ–º—É ID.
        pattern = re.compile(rf"Scroll_{s_num}(?!\d).*Quest_{q_num}(?!\d)")
    # –ï—Å–ª–∏ –Ω–∞ –ª—é–±–æ–º –∏–∑ —ç—Ç–∏—Ö —à–∞–≥–æ–≤ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞...
    except Exception:
        # ...–º—ã –º–æ–ª—á–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, —Ç–∞–∫ –∫–∞–∫ –∫–æ–¥–∞ –¥–ª—è —ç—Ç–æ–≥–æ ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
        return ""

    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–í–µ–ª–∏–∫–∏–π –û–±—Ö–æ–¥" –ø–æ –≤—Å–µ–º –ø–∞–ø–∫–∞–º –∏ —Ñ–∞–π–ª–∞–º –Ω–∞—à–µ–π –¶–∏—Ç–∞–¥–µ–ª–∏.
    for root, _, _ in os.walk(PROJECT_ROOT):
        # –ú—ã –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–∞–ø–∫–∏, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –∑—Ä—è.
        if "site_builder" in root:
            continue
        # –ï—Å–ª–∏ –∏–º—è —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—à–∏–º —à–∞–±–ª–æ–Ω–æ–º...
        if pattern.search(root):
            # ...–º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –∫ –Ω–µ–π...
            target_path = root
            # ...–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ—Ä—ã–≤–∞–µ–º "–í–µ–ª–∏–∫–∏–π –û–±—Ö–æ–¥".
            break

    # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ö–æ–¥–∞ –ø–∞–ø–∫–∞ —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞...
    if not target_path:
        # ...–º—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç.
        return ""

    # –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ–≥–æ –∫–æ–¥–∞ –∫–≤–µ—Å—Ç–∞.
    code_text = ""
    # –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Ç–∏–ø—ã –ø–µ—Ä–≥–∞–º–µ–Ω—Ç–æ–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤) –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç.
    extensions = [
        "*.py",
        "start.sh",
        "Dockerfile",
        "Dockerfile.mono",
        "docker-compose.yml",
        "docker-compose.yaml",
        "prometheus.yml",
        "requirements.txt",
        "requirements_dev.txt",
    ]
    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º —Ü–∏–∫–ª –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É –ø–µ—Ä–≥–∞–º–µ–Ω—Ç–æ–≤.
    for ext in extensions:
        # –ú—ã –∏—â–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø–∞–ø–∫–µ –∫–≤–µ—Å—Ç–∞.
        for file_path in glob.glob(os.path.join(target_path, ext)):
            # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã", —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.
            try:
                # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–≥–∞–º–µ–Ω—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è.
                with open(file_path, "r", encoding="utf-8") as f:
                    # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –Ω–∞—à –æ–±—â–∏–π —Å–≤–∏—Ç–æ–∫ —Å –∫–æ–¥–æ–º,
                    # –ø—Ä–µ–¥–≤–∞—Ä—è—è –µ–≥–æ –∏–º–µ–Ω–µ–º.
                    code_text += (
                        f"\n=== FILE: {os.path.basename(file_path)} ===\n{f.read()}\n"
                    )
            # –ï—Å–ª–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞...
            except Exception:
                # ...–º—ã –º–æ–ª—á–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –ø–µ—Ä–≥–∞–º–µ–Ω—Ç.
                pass
    # --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫: –†–∏—Ç—É–∞–ª—ã CI/CD –≤ –í–µ–ª–∏–∫–æ–π –ë–∏–±–ª–∏–æ—Ç–µ–∫–µ .github ---
    # –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ GitHub Actions.
    workflows_dir = os.path.join(PROJECT_ROOT, ".github", "workflows")
    # –ú—ã —Å–æ–∑–¥–∞–µ–º –º–∞–≥–∏—á–µ—Å–∫–∏–π —à–∞–±–ª–æ–Ω –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞,
    # –∑–∞–º–µ–Ω—è—è —Ç–æ—á–∫—É –≤ ID –∫–≤–µ—Å—Ç–∞ –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
    # (–Ω–∞–ø—Ä–∏–º–µ—Ä, "26.2" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ "*26_2*"), —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–≤–∏—Ç–∫–∏.
    workflow_pattern = f"*{q_id.replace('.', '_')}*"

    # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç...
    if os.path.exists(workflows_dir):
        # ...–º—ã –Ω–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Å—Ä–µ–¥–∏ —Å–≤–∏—Ç–∫–æ–≤ YAML.
        for ext in ["*.yml", "*.yaml"]:
            # –ú—ã –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
            for workflow_path in glob.glob(os.path.join(workflows_dir, ext)):
                # –ï—Å–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—à –º–∞–≥–∏—á–µ—Å–∫–∏–π —à–∞–±–ª–æ–Ω
                # (–æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É –∫–≤–µ—Å—Ç—É)...
                if workflow_pattern in os.path.basename(workflow_path):
                    # ...–º—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã" –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏.
                    try:
                        # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–≤–∏—Ç–æ–∫ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.
                        with open(workflow_path, "r", encoding="utf-8") as f:
                            # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç–æ–µ –∏–º—è —Å–≤–∏—Ç–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞,
                            # –æ—Ç—Å–µ–∫–∞—è –≤–µ—Å—å –ø—É—Ç—å.
                            filename = os.path.basename(workflow_path)
                            # –ú—ã —Å–æ–∑–¥–∞–µ–º –º–∞–≥–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, —á—Ç–æ–±—ã –û—Ä–∞–∫—É–ª –ø–æ–Ω—è–ª,
                            # –æ—Ç–∫—É–¥–∞ —ç—Ç–æ—Ç –∫–æ–¥.
                            file_header = f"\n=== WORKFLOW: {filename} ===\n"
                            # –ú—ã —Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–æ–≥–æ —Å–≤–∏—Ç–∫–∞.
                            file_content = f.read()
                            # –ú—ã —Å–æ–µ–¥–∏–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                            # –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—à –æ–±—â–∏–π –∫–æ–¥–µ–∫—Å.
                            code_text += f"{file_header}{file_content}\n"
                    # –ï—Å–ª–∏ —Å–≤–∏—Ç–æ–∫ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω...
                    except Exception:
                        # ...–º—ã –º–æ–ª—á–∞ –ø—Ä–æ—Ö–æ–¥–∏–º –º–∏–º–æ.
                        pass
    # –ú—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Å–≤–∏—Ç–æ–∫ —Å –∫–æ–¥–æ–º.
    return code_text


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –û—Ä–∞–∫—É–ª–æ–º (—Å "—É–º–Ω—ã–º" –ø–µ—Ä–µ–±–æ—Ä–æ–º –º–æ–¥–µ–ª–µ–π).
def generate_scenario(q_id, legend, code):
    # –ú—ã –æ–≥–ª–∞—à–∞–µ–º –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª (–∫–æ–Ω—Å–æ–ª—å) –Ω–∞—á–∞–ª–æ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
    print(f"‚òÅÔ∏è [AI] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è {q_id}...")

    # –ú—ã —Å–æ–∑–¥–∞–µ–º "–í–µ–ª–∏–∫–æ–µ –ü–æ—Å–ª–∞–Ω–∏–µ" (–ø—Ä–æ–º–ø—Ç), –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –û—Ä–∞–∫—É–ª—É.
    prompt = f"""
TASK: You are a Linux Terminal Simulator generator.
Based on the INSTRUCTION (what the user should do) and the REAL CODE
(what is actually in the files), generate a JSON scenario.

INSTRUCTION:
{legend}

REAL CODE FILES:
{code}

REQUIREMENTS:
1. Output ONLY valid JSON. No markdown, no comments.
2. Format: Array of objects.
   - "command": The exact command user should type (e.g. "python quest.py"
     or "pip install..."). Infer this from the instruction and file names.
   - "output": Realistic terminal output.
     * If the python code has print("Hello"), the output MUST contain "Hello".
     * If it's a training script, generate fake but realistic logs (Epoch 1..).
     * If it's pip install, generate pip logs.
   - "is_final": boolean. Set to true ONLY for the very last command
     in the sequence.

EXAMPLE JSON:
[
  {{"command": "conda activate env", "output": "(env) user@host:~$ "}},
  {{"command": "python main.py", "output": "Starting...\\nDone.", "is_final": true}}
]
"""

    # –ú—ã –æ–±—ä—è–≤–ª—è–µ–º, —á—Ç–æ –±—É–¥–µ–º –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞—à "–ö—Ä–∏—Å—Ç–∞–ª–ª –ü–∞–º—è—Ç–∏",
    # –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç—Ç–æ–≥–æ —Ä–∏—Ç—É–∞–ª–∞.
    global LAST_SUCCESSFUL_MODEL

    # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –Ω–∞—à "–ö—Ä–∏—Å—Ç–∞–ª–ª –ü–∞–º—è—Ç–∏" –Ω–µ –ø—É—Å—Ç
    # –∏ –∏–º—è –û—Ä–∞–∫—É–ª–∞ –≤ –Ω–µ–º –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ...
    if LAST_SUCCESSFUL_MODEL and LAST_SUCCESSFUL_MODEL in MODELS:
        # ...–º—ã —Å–æ–≤–µ—Ä—à–∞–µ–º —Ä–∏—Ç—É–∞–ª "–í–æ–∑–Ω–µ—Å–µ–Ω–∏—è": –≤—ã–Ω–∏–º–∞–µ–º –∏–º—è —É—Å–ø–µ—à–Ω–æ–≥–æ –û—Ä–∞–∫—É–ª–∞
        # –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ —Å—Ç–∞–≤–∏–º –µ–≥–æ –Ω–∞ –ø–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ.
        MODELS.insert(0, MODELS.pop(MODELS.index(LAST_SUCCESSFUL_MODEL)))

    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –≤–µ–ª–∏–∫–∏–π —Ü–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—è –≤—Å–µ—Ö –û—Ä–∞–∫—É–ª–æ–≤ –∏–∑ –Ω–∞—à–µ–≥–æ (–≤–æ–∑–º–æ–∂–Ω–æ,
    # –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) —Å–ø–∏—Å–∫–∞.
    for model_id in MODELS:
        # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã" –æ—Ç –æ—à–∏–±–æ–∫ —Å–≤—è–∑–∏ —Å –û—Ä–∞–∫—É–ª–æ–º.
        try:
            # –ú—ã –æ–≥–ª–∞—à–∞–µ–º, –∫ –∫–∞–∫–æ–º—É –∏–º–µ–Ω–Ω–æ –û—Ä–∞–∫—É–ª—É –º—ã —Å–µ–π—á–∞—Å –æ–±—Ä–∞—â–∞–µ–º—Å—è.
            print(f"   üëâ –ü—Ä–æ–±—É–µ–º {model_id}...")
            # –ú—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—à–µ "–ü–æ—Å–ª–∞–Ω–∏–µ" –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤–æ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞.
            completion = client.chat.completions.create(
                # –£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –û—Ä–∞–∫—É–ª–∞.
                model=model_id,
                # –ü–µ—Ä–µ–¥–∞–µ–º —Å–∞–º–æ "–ü–æ—Å–ª–∞–Ω–∏–µ".
                messages=[{"role": "user", "content": prompt}],
                # –ü—Ä–æ—Å–∏–º –û—Ä–∞–∫—É–ª–∞ –±—ã—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º (–Ω–∏–∑–∫–∞—è "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞").
                temperature=0.1,
            )
            # –£–°–ü–ï–•! –ú—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–º—è —ç—Ç–æ–≥–æ –û—Ä–∞–∫—É–ª–∞ –≤ –Ω–∞—à "–ö—Ä–∏—Å—Ç–∞–ª–ª –ü–∞–º—è—Ç–∏".
            LAST_SUCCESSFUL_MODEL = model_id
            # –ú—ã –æ–≥–ª–∞—à–∞–µ–º –æ–± —É—Å–ø–µ—Ö–µ –∏ –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É, —á—Ç–æ–±—ã –Ω–µ –∑–ª–∏—Ç—å –±–æ–≥–æ–≤ API.
            print("   ‚úÖ –£—Å–ø–µ—Ö. –ñ–¥–µ–º 4 —Å–µ–∫...")
            # –ú—ã –ø—Ä–∏–∑—ã–≤–∞–µ–º –¥—É—Ö–∞ –í—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –æ–Ω –∑–∞–º–æ—Ä–æ–∑–∏–ª —Ä–∏—Ç—É–∞–ª –Ω–∞ 4 —Å–µ–∫—É–Ω–¥—ã.
            time.sleep(1)
            # –ú—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å—Ç–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –û—Ä–∞–∫—É–ª–∞, –∑–∞–≤–µ—Ä—à–∞—è —Ä–∏—Ç—É–∞–ª.
            return completion.choices[0].message.content

        # –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—â–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞...
        except Exception as e:
            # ...–º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø—Ä–æ–∫–ª—è—Ç–∏–µ–º "–õ–∏–º–∏—Ç–∞ –ó–∞–ø—Ä–æ—Å–æ–≤" (429).
            if "429" in str(e):
                # –ï—Å–ª–∏ –¥–∞, –º—ã —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º –ú–∞–≥—É...
                print(f"   ‚è≥ –õ–∏–º–∏—Ç 429 —É {model_id}. –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é...")
                # ...–¥–µ–ª–∞–µ–º –∫–æ—Ä–æ—Ç–∫—É—é –ø–∞—É–∑—É...
                time.sleep(1)
                # ...–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –û—Ä–∞–∫—É–ª—É –≤ —Å–ø–∏—Å–∫–µ.
                continue
            # –ï—Å–ª–∏ –∂–µ —ç—Ç–æ –¥—Ä—É–≥–∞—è, –Ω–µ–≤–µ–¥–æ–º–∞—è –æ—à–∏–±–∫–∞...
            else:
                # ...–º—ã —Ç–∞–∫–∂–µ —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º...
                print(f"   ‚ùå –û—à–∏–±–∫–∞ {model_id}: {e}")
                # ...–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –û—Ä–∞–∫—É–ª—É.
                continue

    # –ï—Å–ª–∏ –º—ã –ø—Ä–æ—à–ª–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫, –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –º—ã –æ–≥–ª–∞—à–∞–µ–º –æ –ø–æ–ª–Ω–æ–º –ø—Ä–æ–≤–∞–ª–µ.
    print(f"‚ùå‚ùå‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –¥–ª—è {q_id} –Ω–∏ –æ—Ç –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏.")
    # –ú—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "–ø—É—Å—Ç–æ—Ç—É" –≤ –∑–Ω–∞–∫ –Ω–µ—É–¥–∞—á–∏.
    return None


# –ß–µ—Ä—Ç–µ–∂ —Ä–∏—Ç—É–∞–ª–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –û—Ä–∞–∫—É–ª–∞ (—Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å—é).
def clean_json(text):
    """–ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —á–∏—Å—Ç–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç markdown-–æ–±–µ—Ä—Ç–∫–∏ –∏ —Ç–µ–∫—Å—Ç–∞."""
    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã", —Ç–∞–∫ –∫–∞–∫ –æ—Ç–≤–µ—Ç –û—Ä–∞–∫—É–ª–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º.
    try:
        # –°–Ω–∞—á–∞–ª–∞ –º—ã –∏—â–µ–º JSON, –∑–∞–ø–µ—á–∞—Ç–∞–Ω–Ω—ã–π –≤ markdown-–±–ª–æ–∫ –∫–æ–¥–∞.
        match = re.search(r"```json\s*([\s\S]*?)\s*```", text, re.DOTALL)
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏...
        if match:
            # ...–º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞...
            json_text = match.group(1).strip()
            # ...–∏ –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ –≤ –æ–±—ä–µ–∫—Ç Python.
            return json.loads(json_text)

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ markdown, –∏—â–µ–º –ø—Ä–æ—Å—Ç–æ –º–∞—Å—Å–∏–≤, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å '[' –∏
        # –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–π—Å—è ']'.
        match = re.search(r"\[.*\]", text, re.DOTALL)
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏...
        if match:
            # ...–º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –º–∞—Å—Å–∏–≤–∞...
            json_text = match.group(0).strip()
            # ...–∏ –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –µ–≥–æ –≤ –æ–±—ä–µ–∫—Ç Python.
            return json.loads(json_text)

        # –ï—Å–ª–∏ –∏ —Ç–∞–∫ –Ω–µ –Ω–∞—à–ª–∏, –º—ã —Ä–∏—Å–∫—É–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞.
        return json.loads(text)
    # –ï—Å–ª–∏ –Ω–∞ –ª—é–±–æ–º –∏–∑ —ç—Ç–∏—Ö —à–∞–≥–æ–≤ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞...
    except Exception:
        # ...–º—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "–ø—É—Å—Ç–æ—Ç—É" –≤ –∑–Ω–∞–∫ —Ç–æ–≥–æ, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–µ–Ω.
        return None


# --- –ê–∫—Ç 4: –ì–ª–∞–≤–Ω—ã–π –†–∏—Ç—É–∞–ª ---
# –ß–µ—Ä—Ç–µ–∂ –≥–ª–∞–≤–Ω–æ–≥–æ —Ä–∏—Ç—É–∞–ª–∞, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏.
def main():
    # –°–Ω–∞—á–∞–ª–∞ –º—ã —á–∏—Ç–∞–µ–º –í–µ–ª–∏–∫—É—é –õ–µ—Ç–æ–ø–∏—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–≤–µ—Å—Ç–æ–≤.
    legends = parse_codex_legends()
    # –ú—ã –æ–≥–ª–∞—à–∞–µ–º –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª, —Å–∫–æ–ª—å–∫–æ –∫–≤–µ—Å—Ç–æ–≤ –Ω–∞–º –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å.
    print(f"üìú –ö–≤–µ—Å—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ: {len(legends)}")

    # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –≤–µ–ª–∏–∫–∏–π —Ü–∏–∫–ª, –ø—Ä–æ—Ö–æ–¥—è –ø–æ –∫–∞–∂–¥–æ–º—É –∫–≤–µ—Å—Ç—É –∏–∑ –Ω–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞.
    for q_id, legend in legends.items():
        # –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –¥–æ–ª–∂–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—å—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
        target_file = os.path.join(SCENARIOS_DIR, f"quest_{q_id}.json")
        # –ú—ã —Å–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –∫–æ–¥, –æ—Ç–Ω–æ—Å—è—â–∏–π—Å—è –∫ —ç—Ç–æ–º—É –∫–≤–µ—Å—Ç—É.
        code = get_quest_code(q_id)

        # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –¥–ª—è –∫–≤–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–¥–∞...
        if not code:
            # ...–º—ã —Å–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é "–∑–∞–≥–ª—É—à–∫—É" –¥–ª—è –û—Ä–∞–∫—É–ª–∞.
            code = (
                "(No code files found in directory. "
                "Generate generic logs based on instruction.)"
            )

        # –ú—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º "–ú–∞–≥–∏—á–µ—Å–∫—É—é –ü–æ–¥–ø–∏—Å—å" –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        input_hash = calculate_input_hash(legend, code)

        # –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞.
        if os.path.exists(target_file):
            # –ú—ã –Ω–∞—á–∏–Ω–∞–µ–º "–±–ª–æ–∫ –∑–∞—â–∏—Ç—ã", —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.
            try:
                # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è.
                with open(target_file, "r", encoding="utf-8") as f:
                    # –ú—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–±—ä–µ–∫—Ç Python.
                    existing_data = json.load(f)

                # –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
                # –Ω–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É —Å "–ú–∞–≥–∏—á–µ—Å–∫–æ–π –ü–æ–¥–ø–∏—Å—å—é".
                if isinstance(existing_data, dict) and "_meta" in existing_data:
                    # –ú—ã –∏–∑–≤–ª–µ–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –≤ –Ω–µ–º –ø–æ–¥–ø–∏—Å—å.
                    saved_hash = existing_data["_meta"].get("input_hash")
                    # –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–µ–π...
                    if saved_hash == input_hash:
                        # ...–º—ã —Å–æ–æ–±—â–∞–µ–º –ú–∞–≥—É, —á—Ç–æ —Ä–∞–±–æ—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è,
                        # –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –∫–≤–µ—Å—Ç.
                        print(f"‚è© –°–∫–∏–ø: {q_id} (–∫–æ–¥ –∏ –ª–µ–≥–µ–Ω–¥–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)")
                        continue
            # –ï—Å–ª–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞...
            except Exception:
                # ...–º—ã –º–æ–ª—á–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç.
                pass

        # –ï—Å–ª–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å, –º—ã –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ –û—Ä–∞–∫—É–ª—É.
        response = generate_scenario(q_id, legend, code)

        # "–°—Ç—Ä–∞–∂-–ü—Ä–æ–≤–µ—Ä–∫–∞": –µ—Å–ª–∏ –û—Ä–∞–∫—É–ª –æ—Ç–≤–µ—Ç–∏–ª...
        if response:
            # ...–º—ã –æ—á–∏—â–∞–µ–º –µ–≥–æ –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤.
            scenario_array = clean_json(response)
            # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —É –Ω–∞—Å –ø–æ–ª—É—á–∏–ª—Å—è –≤–∞–ª–∏–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç...
            if scenario_array:
                # ...–º—ã —Å–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –≤ –≤–∏–¥–µ –æ–±—ä–µ–∫—Ç–∞ Python.
                final_artifact = {
                    # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞-—Å–µ–∫—Ü–∏—é, –≥–¥–µ —Ö—Ä–∞–Ω–∏–º "–ú–∞–≥–∏—á–µ—Å–∫—É—é –ü–æ–¥–ø–∏—Å—å"
                    # –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
                    "_meta": {"input_hash": input_hash},
                    # –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å–∞–º –º–∞—Å—Å–∏–≤ —Å—Ü–µ–Ω–∞—Ä–∏—è, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç –û—Ä–∞–∫—É–ª–∞.
                    "scenario": scenario_array,
                }
                # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–æ–≤–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.
                with open(target_file, "w", encoding="utf-8") as f:
                    # –ú—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–∞ –¥–∏—Å–∫ –≤ –∫—Ä–∞—Å–∏–≤–æ–º, —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
                    json.dump(final_artifact, f, indent=2, ensure_ascii=False)
                # –ú—ã –æ–≥–ª–∞—à–∞–µ–º –æ–± —É—Å–ø–µ—Ö–µ.
                print(f"‚úÖ –ì–æ—Ç–æ–≤–æ: {target_file}")
            # –ï—Å–ª–∏ –∂–µ –æ—Ç–≤–µ—Ç –û—Ä–∞–∫—É–ª–∞ –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º JSON...
            else:
                # ...–º—ã —Å–æ–æ–±—â–∞–µ–º –ú–∞–≥—É –æ–± —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º–µ.
                print(f"‚ùå AI –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –¥–ª—è {q_id}")


# "–°–≤—è—â–µ–Ω–Ω–æ–µ –ù–∞—á–∞–ª–æ". –≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞,
# –∫–æ–≥–¥–∞ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é.
if __name__ == "__main__":
    # –ú—ã –∑–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª.
    main()
