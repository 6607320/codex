# scenarios_builder.py Specification

## 1. Meta Information

- **Domain:** Scripting
- **Complexity:** Medium
- **Language:** Python
- **Frameworks:** openai, python-dotenv
- **Context:** ../AGENTS.md

## 2. Goal & Purpose (–¶–µ–ª—å –∏ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ)

**Context for Creator:** –≠—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ-—Ä–∏—Ç—É–∞–ª, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –í–µ–ª–∏–∫–∏–µ –õ–µ—Ç–æ–ø–∏—Å–∏ CODEX.md, —Å–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã –∫–≤–µ—Å—Ç–æ–≤ –∏ –∏—Ö –∫–æ–¥–æ–≤—É—é –æ—Å–Ω–æ–≤—É, –≤—ã—á–∏—Å–ª—è–µ—Ç –º–∞–≥–∏—á–µ—Å–∫—É—é –ø–æ–¥–ø–∏—Å—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –º–æ–≥—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É –û—Ä–∞–∫—É–ª—É (OpenRouter) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –ü–æ–¥–ø–∏—Å—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ —ç–∫–æ–Ω–æ–º–∏—Ç –º–∞–Ω—É. –ü–æ –∏—Ç–æ–≥–∞–º —Ä–∏—Ç—É–∞–ª–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –≤ –≤–∏–¥–µ JSON-—Ñ–∞–π–ª–∞ quest\_<id>.json, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

**Instruction for AI:** –≠—Ç–æ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã—Å—à–µ–≥–æ –∑–∞–º—ã—Å–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∑–∞—á–µ–º –Ω—É–∂–µ–Ω –∫–æ–¥: orchestrating extraction, hashing, remote generation, –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –Ω–µ —Ç—Ä–∞—Ç–æ–≤–∞–ª–∏ —Ä–µ—Å—É—Ä—Å—ã.

---

## 3. Interface Contract (–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã–π –ö–æ–Ω—Ç—Ä–∞–∫—Ç)

### 3.1. Inputs (–í—Ö–æ–¥—ã)

- **Source:** CLI Args
- **Format:** Text
- **Schema:**
  interface InputData {
  q_id: string;
  legend: string;
  code: string;
  }

### 3.2. Outputs (–í—ã—Ö–æ–¥—ã)

- **Destination:** File
- **Format:** JSON
- **Success Criteria:** File Created
- **Schema:**
  interface OutputArtifact {
  \_meta: { input_hash: string };
  scenario: any[];
  }

  interface OutputEnvelope {
  destination: 'File';
  path: string;
  artifact: OutputArtifact;
  }

---

## 4. Implementation Details (The Source DNA / –ò—Å—Ö–æ–¥–Ω—ã–π –ö–æ–¥)

### 4.1. Algorithmic Logic (–î–ª—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –∫–æ–¥–∞)

- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–µ–∫—Ä–µ—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env: OPENROUTER_API_KEY –∏ OPENROUTER_BASE_URL. –ï—Å–ª–∏ –∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ –∏ —Ä–∏—Ç—É–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è.
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –û—Ä–∞–∫—É–ª–∞ (MODELS) –∏–∑ MODELS_LIST –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –Ω–∞–±–æ—Ä. –ú–æ–¥–µ–ª–∏ —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞—é—Ç—Å—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É; LAST_SUCCESSFUL_MODEL –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –ø–æ—Ä—è–¥–æ–∫, –ø–æ–¥–Ω–∏–º–∞—è —É–¥–∞—á–Ω—ã–π –û—Ä–∞–∫—É–ª –Ω–∞ –ø–µ—Ä–≤—ã–π –ø–ª–∞–Ω.
- –°–æ–∑–¥–∞—ë—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ SCENARIOS_DIR, –µ—Å–ª–∏ –µ—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç OpenAI —Å base_url –∏ api_key.
- –§—É–Ω–∫—Ü–∏–∏-—Ä–∏–∏—Ç—É–∞–ª—ã:
  - calculate_input_hash(legend, code): –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ—á–µ—Ç–∞–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã –∏ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é MD5, –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É-—Ö–µ—à.
  - parse_codex_legends(): –ø—Ä–æ—á–∏—Ç–∞—Ç—å CODEX.md, —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –±–ª–æ–∫–∏ –∫–≤–µ—Å—Ç–æ–≤ –∏ –∏–∑–≤–ª–µ—á—å –ª–µ–≥–µ–Ω–¥—ã –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤–∏–¥–∞ <!-- Legend -->, –≤–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–∞—Ä—å { q_id: legend }.
  - get*quest_code(q_id): –Ω–∞–π—Ç–∏ –ø–∞–ø–∫—É –∫–≤–µ—Å—Ç–∞ –ø–æ —à–∞–±–ª–æ–Ω—É Scroll*<s*num> Quest*<q_num>, —Å–æ–±—Ä–∞—Ç—å –≤–µ—Å—å –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º (py, sh, Dockerfile –∏ –ø—Ä.), –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –µ–¥–∏–Ω—ã–π –∫–æ–¥–æ–≤—ã–π —Å–≤–∏—Ç–æ–∫. –¢–∞–∫–∂–µ –≤–∫–ª—é—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö GitHub Actions workflow-—Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã. –í–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–æ–¥–∞ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
  - generate_scenario(q_id, legend, code): —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è –û—Ä–∞–∫—É–ª–∞, –ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–¥—Ä—è–¥ –∫–∞–∂–¥—É—é –º–æ–¥–µ–ª—å –∏–∑ MODELS, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ 429: –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤) –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–µ–ª–∏; —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è —É—Å–ø–µ—à–Ω–æ–≥–æ –û—Ä–∞–∫—É–ª–∞ –≤ LAST_SUCCESSFUL_MODEL; –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É-–æ—Ç–≤–µ—Ç –æ—Ç –û—Ä–∞–∫—É–ª–∞ –∏–ª–∏ None –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ.
  - clean_json(text): –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç –û—Ä–∞–∫—É–ª–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö –æ–±—Ä–∞–º–ª–µ–Ω–∏–π –∏ –≤–µ—Ä–Ω—É—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π Python-–æ–±—ä–µ–∫—Ç (–æ–±—ã—á–Ω–æ —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤) –∏–ª–∏ None.
  - main(): –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ª–µ–≥–µ–Ω–¥—ã —á–µ—Ä–µ–∑ parse*codex_legends, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ q_id –≤—ã—á–∏—Å–ª–∏—Ç—å —Ü–µ–ª–µ–≤–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç quest*<q_id>.json, —Å–æ–±—Ä–∞—Ç—å –∫–æ–¥ —á–µ—Ä–µ–∑ get_quest_code, –µ—Å–ª–∏ –∫–æ–¥–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å input_hash. –ï—Å–ª–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø–æ–¥–ø–∏—Å—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–≤–µ—Å—Ç. –ò–Ω–∞—á–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –û—Ä–∞–∫—É–ª—É —á–µ—Ä–µ–∑ generate_scenario, –æ—á–∏—Å—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ clean_json, —Å–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å –ø–æ–ª—è–º–∏ \_meta.input_hash –∏ scenario, –∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ –≤ —Ñ–∞–π–ª –≤ SCENARIOS_DIR. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –Ω–µ—Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
- –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ä–∞–¥–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Ç—É–∞–ª—ã: hashing, —Å–±–æ—Ä –∫–æ–¥–∞, –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –æ—á–∏—Å—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

### 4.2. Declarative Content (–î–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö)

- –ú–∞–≥–∏—á–µ—Å–∫–∏–π –°–≤–∏—Ç–æ–∫ –õ–µ—Ç–æ–ø–∏—Å–µ–π: CODEX.md ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–≤–µ—Å—Ç–æ–≤ –∏ –ª–µ–≥–µ–Ω–¥.
- –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤: SCENARIOS*DIR/static/scenarios ‚Äî –º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è quest*<id>.json.
- –í–µ–ª–∏–∫–∏–π –ü–æ—Ä—Ç–∞–ª –û—Ä–∞–∫—É–ª–∞: OPENROUTER_API_KEY –∏ OPENROUTER_BASE_URL ‚Äî —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ OpenRouter.
- –°–ø–∏—Å–æ–∫ –ú–æ–¥–µ–ª–µ–π: MODELS ‚Äî —Å–ø–∏—Å–æ–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –º–æ–¥–µ–ª–µ–π –û—Ä–∞–∫—É–ª–∞.
- –ö–∞–º–µ–Ω—å –ü–∞–º—è—Ç–∏ LAST_SUCCESSFUL_MODEL ‚Äî —Ö—Ä–∞–Ω–∏—Ç –∏–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞—á–Ω–æ–≥–æ –û—Ä–∞–∫—É–ª–∞.
- –í–µ–∫–æ–≤—ã–µ –¢–æ—á–∏–ª—å—â–∏–∫–∏: —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞, –≤–∫–ª—é—á–∞—è —Ñ–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ .py, start.sh, Dockerfile, Dockerfile.mono, docker-compose.yml/.yaml, prometheus.yml, requirements.txt, requirements_dev.txt.
- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-–∞–ª—Ö–∏–º–∏–∫–∏: calculate_input_hash, parse_codex_legends, get_quest_code, generate_scenario, clean_json, main.
- –ê—Ä–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è: os, json, re, glob, hashlib, time, OpenAI –∫–ª–∏–µ–Ω—Ç, dotenv –∑–∞–≥—Ä—É–∑—á–∏–∫.
- –≠—Ñ–∏—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: legend (–ª–µ–≥–µ–Ω–¥–∞ –∫–≤–µ—Å—Ç–∞), code (–∫–æ–¥ –∫–≤–µ—Å—Ç–∞), q_id (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–≤–µ—Å—Ç–∞), input_hash (–º–∞–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö), scenario (–º–∞—Å—Å–∏–≤ —Å—Ü–µ–Ω–∞—Ä–∏–µ–º), artifact (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç).

–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (Inventory) –≤ —Ñ–æ—Ä–º–∞—Ç–µ RPG-–ø—Ä–µ–¥–º–µ—Ç–æ–≤:

- üè∞ CODEX.md ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –ª–µ–≥–µ–Ω–¥ –∏ –∑–∞–¥–∞–Ω–∏–π.
- üõ°Ô∏è SCENARIOS*DIR ‚Äî –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ quest*<id>.json.
- üóùÔ∏è OPENROUTER_API_KEY, OPENROUTER_BASE_URL ‚Äî –ø—É—Ç–∏ –∫ –û—Ä–∞–∫—É–ª—É.
- üß≠ MODELS ‚Äî –∫–æ–º–ø–∞—Å –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π.
- üîÆ LAST_SUCCESSFUL_MODEL ‚Äî –∫–∞–º–µ–Ω—å –ø–∞–º—è—Ç–∏ —É–¥–∞—á–∏ –º–æ–¥–µ–ª–∏.
- üß≠ –ê—Ä—Ö–∏–≤ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞: \*.py, start.sh, Dockerfile, docker-compose.yml, etc.
- üó∫Ô∏è –†–µ–≥—É–ª—è–º—ã –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: legend, code, q_id.
- ‚è≥ input_hash ‚Äî –º–∞–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- üìú scenario ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –û—Ä–∞–∫—É–ª–æ–º.

---

## 5. Structural Decomposition (–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è: LAST_SUCCESSFUL_MODEL, BASE_DIR, PROJECT_ROOT, SCENARIOS_DIR, CODEX_FILE, OPENROUTER_API_KEY, OPENROUTER_BASE_URL, MODELS, client.
- –§—É–Ω–∫—Ü–∏–∏:
  - calculate_input_hash(legend, code)
  - parse_codex_legends()
  - get_quest_code(q_id)
  - generate_scenario(q_id, legend, code)
  - clean_json(text)
  - main()
- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã: –∑–∞–≥—Ä—É–∑–∫–∞ dotenv, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, —Ä–∞–±–æ—Ç–∞ —Å OpenAI –∫–ª–∏–µ–Ω—Ç–æ–º, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.
- –†–∏—Ç—É–∞–ª—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏: –≤—ã–¥–∞—á–∞ –ø—Ä–æ–º–ø—Ç–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤, —Ä–µ–≥—É–ª—è—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ –ø–æ–ø—ã—Ç–æ–∫.

---

## 6. System Context & Constraints (–°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)

### 6.1. Technical Constraints

- **Performance:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π CPU; —Å–µ—Ç—å-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è duelist; —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∫ –º–æ–¥–µ–ª–∏ –û—Ä–∞–∫—É–ª–∞.
- **Concurrency:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è; –æ–±—Ö–æ–¥ –ø–æ –∫–≤–µ—Å—Ç–∞–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
- **Dependencies:** openai, python-dotenv, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Python (os, json, re, glob, hashlib, time).

### 6.2. Prohibited Actions (Negative Constraints)

- DO NOT store secrets in plain text (use .env).
- DO NOT print raw data to console in production mode.
- DO NOT hardcode API keys –≤ –∫–æ–¥–µ.
- DO NOT –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (.yaml, .json) –≤–Ω—É—Ç—Ä—å —Å–∫—Ä–∏–ø—Ç–æ–≤.
- DO NOT –º–µ–Ω—è—Ç—å –≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–ª–∏ –ø—É—Ç–∏ –≤–æ –≤—Ä–µ–º—è —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
- DO NOT –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏–º–∏—Ç 429: –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–µ–ª–∏ –≤ —Å–ø–∏—Å–∫–µ.

---

## 7. Verification & Testing (–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è)

1. Happy Path (–ì–∞—Ä–º–æ–Ω–∏—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)

- –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏–µ: CODEX.md –¥–æ—Å—Ç—É–ø–µ–Ω, –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç OPENROUTER_API_KEY –∏ OpenRouter –±–∞–∑–æ–≤—ã–π URL; SCENARIOS_DIR —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω; MODELS —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—É—é –º–æ–¥–µ–ª—å.
- –î–µ–π—Å—Ç–≤–∏–µ: –∑–∞–ø—É—â–µ–Ω –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª; –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–≤–µ—Å—Ç–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ª–µ–≥–µ–Ω–¥–∞ –∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–æ–¥; –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –û—Ä–∞–∫—É–ª–æ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON-—Å—Ü–µ–Ω–∞—Ä–∏–π; –∞—Ä—Ç–µ—Ñ–∞–∫—Ç quest\_<id>.json —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é \_meta.input_hash.
- –û–∂–∏–¥–∞–µ–º–æ–µ: —Ñ–∞–π–ª –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ —Å–æ–∑–¥–∞–Ω, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç OutputArtifact.

2. –û—à–∏–±–∫–∞ –ª–∏–º–∏—Ç–∞/–Ω–µ—É–¥–∞—á–∏ (429 –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–µ–ª–∏)

- –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏–µ: –ø–µ—Ä–≤—ã–π –û—Ä–∞–∫—É–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 429; –ø–æ—Å–ª–µ–¥—É—é—â–∏–π —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç.
- –î–µ–π—Å—Ç–≤–∏–µ: —Ä–∏—Ç—É–∞–ª –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫ 429; –≤ –∏—Ç–æ–≥–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é.
- –û–∂–∏–¥–∞–µ–º–æ–µ: –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–æ–∑–¥–∞–Ω; –ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–æ–¥–µ–ª–∏ –∏ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å —É—Å–ø–µ—Ö–æ–º.

–ì–µ—Ä–∫–∏–Ω-–ø—Ä–∞–≤–∏–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∏–∂–µ.

Gherkin —Å—Ü–µ–Ω–∞—Ä–∏–∏:

Feature: Scenarios Builder
Scenario: Successful generation
Given CODEX.md exists with legends and environment contains valid API key
When main() processes all legends and successfully receives AI responses
Then quest\_<id>.json files are created in static/scenarios with \_meta.input_hash matching calculated value

Scenario: Rate limit handling and fallback
Given first AI model returns 429 and a subsequent model succeeds
When main() handles error by trying next model
Then at least one quest\_<id>.json artifact is created with a valid \_meta.input_hash

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É: –µ—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –∫–≤–µ—Å—Ç–æ–≤ –≤ CODEX.md –Ω–µ—Ç –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ LEGEND –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∞, –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã; —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –æ—Ç—Ä–∞–∂–∞—é—Ç —ç—Ç–æ—Ç —Ö–∞–æ—Å –≠—Ñ–∏—Ä–∞ –ö–∞–∫–æ–π-—Ç–æ –≤—ã–∑–æ–≤ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—É—é —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Ö–∞–æ—Å—É —á–µ—Ä–µ–∑ —è–≤–Ω—É—é –ø–æ–¥–ø–∏—Å—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤. Independent Artifact
