# Используем стандартный, полный образ Python. Он больше, но надежнее.
FROM python:3.10

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем свиток зависимостей
COPY libraries.list .

# Устанавливаем зависимости НАПРЯМУЮ в финальный образ
RUN pip install --no-cache-dir -r libraries.list

# --- Ритуал Предварительного Призыва Знаний ---
COPY download_model.py .
RUN python download_model.py

# Копируем наш код
COPY main.py .

# --- Толкование: Скрипт Пробуждения (start.sh) ---
# Мы используем отдельный скрипт `start.sh`, а не просто `CMD ["uvicorn"...]`,
# чтобы гарантированно исполнить 'Главное Заклинание Жизни' в чистой среде.
# Этот метод защищает нас от 'проклятия кодировок' (`exec format error`) и
# позволяет гибко использовать 'секретную руну окружения' `${PORT}`,
# которую диктует Облачная Цитадель (`Cloud Run`).

# Копируем пергамент со "Заклинанием Пробуждения" в нашу мастерскую.
COPY start.sh .
# Даруем этому пергаменту "право на жизнь", делая его исполняемым.
RUN chmod +x ./start.sh
# Приказываем Голему при своем пробуждении исполнить "Заклинание Пробуждения".
CMD ["./start.sh"]
