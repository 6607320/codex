# main.py Specification

## 1. Meta Information

- Domain: Scripting
- Complexity: High
- Language: Python
- Frameworks: FastAPI, Pydantic, transformers, prometheus_fastapi_instrumentator, prometheus_client
- Context: ../AGENTS.md

## 2. Goal & Purpose (–õ–µ–≥–µ–Ω–¥–∞)

–≠—Ç–æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç ‚Äî –∫–ª—é—á –∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –∫—É–∑–Ω–∏—á–Ω–æ–º—É –∫–æ–Ω–≤–µ–π–µ—Ä—É –ú–õ-–ø–∞–π–ø–ª–∞–π–Ω–∞. –û–Ω –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–π –º–∞–≥–∏–∏ –≤ –∫–æ–¥, –Ω–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫—É–ª—å–º–∏–Ω–∞—Ü–∏—é MLOps: –ø–æ–ª–Ω–æ–º–∞—Å—à—Ç–∞–±–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä –æ—Ç —Ñ–∏–∫—Å–∞ –≤ Git –¥–æ —Å–±–æ—Ä–∫–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –≤ Google Artifact Registry, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –¥–≤–æ–π—Å—Ç–≤–µ–Ω–Ω—ã–π —Ö—Ä–∞–º–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑: AB-—Ç–µ—Å—Ç –¥–≤—É—Ö –º–æ–¥–µ–ª–µ–π —ç–º–ø–∞—Ç–∏–π–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏ –ø–æ–ª–∏–≤–∞–µ—Ç –ø–æ—Ä—Ç–∞–ª Prometheus-–º–µ—Ç—Ä–∏–∫–æ–π, —á—Ç–æ–±—ã –Ω–∞–¥–∑–∏—Ä–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤. –≠—Ç–æ –≤–µ—Ä—Å–∏—è 3.0 ‚Äî –ê–¥–µ–ø—Ç –†–∞–∑–≤–∏–≤–∫–æ–π –≤ –°—Ç–∞–ª—å–Ω–æ–π –ú–∏—Å—Å–∏–∏.

## 3. Interface Contract (–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã–π –ö–æ–Ω—Ç—Ä–∞–∫—Ç)

### 3.1. Inputs (–í—Ö–æ–¥—ã)

- Source: API Request
- Format: JSON
- Schema: InputData
  - text: string

### 3.2. Outputs (–í—ã—Ö–æ–¥—ã)

- Destination: API Response
- Format: JSON
- Success Criteria: 200 OK
- Schema: OutputResult
  - result: object
  - model_version: string

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –¥–∞–Ω–Ω—ã—Ö –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–ª–µ result —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—ã–≤–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏ label/score –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω sentiment-analysis). model_version ‚Äî –ª–∏–±–æ "A", –ª–∏–±–æ "B".

## 4. Implementation Details (The Source DNA / –ò—Å—Ö–æ–¥–Ω—ã–π –ö–æ–¥)

### 4.1. Algorithmic Logic (–î–ª—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –∫–æ–¥–∞)

- –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–≤–µ –º–æ–¥–µ–ª–∏ —ç–º–ø–∞—Ç–∏–π–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ –ø–∞–π–ø–ª–∞–π–Ω: –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å A –Ω–∞ DistilBERT (sentiment-analysis), –≤—Ç–æ—Ä—É—é –º–æ–¥–µ–ª—å B –Ω–∞ RoBERTa (sentiment-analysis).
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ö–µ–º—É –≤—Ö–æ–¥–∞ TextInput —Å –ø–æ–ª–µ–º text (—Å—Ç—Ä–æ–∫–∞).
- –°–æ–∑–¥–∞—Ç—å FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∏–º–µ–Ω–µ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º, –∏ –≤–∫–ª—é—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ Prometheus —á–µ—Ä–µ–∑ Instrumentator.
- –°–æ–∑–¥–∞—Ç—å –¥–≤–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–±–æ—Ä—ã –º–µ—Ç—Ä–∏–∫:
  - –ú–∞–Ω–æ–º–µ—Ç—Ä —Ç–æ—á–Ω–æ—Å—Ç–∏ (Gauge) –ø–æ–¥ –∏–º–µ–Ω–µ–º model_accuracy, –∏–∑–º–µ—Ä—è—é—â–∏–π —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ.
  - –ö—Ä–∏—Å—Ç–∞–ª–ª-–°—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ (Counter) –ø–æ–¥ –∏–º–µ–Ω–µ–º model_requests_total, —Å –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º –ø–æ –∏–∑–º–µ—Ä–µ–Ω–∏—é model_version (A –∏–ª–∏ B).
- –û–±—ä—è–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç POST /analyze:
  - –ü—Ä–∏–Ω—è—Ç—å —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ TextInput.
  - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä: –ª–∏–±–æ –ø—É—Ç—å –ê (model_a), –ª–∏–±–æ –ø—É—Ç—å –ë (model_b).
  - –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ REQUEST_COUNTER –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏.
  - –ü–µ—Ä–µ–¥–∞—Ç—å —Ç–µ–∫—Å—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–º–µ—Å—Ç–µ —Å model_version.
- –û–±—ä—è–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç POST /validate:
  - –ü—Ä–æ–≥–Ω–∞—Ç—å –≤–µ—Å—å –Ω–∞–±–æ—Ä VALIDATION_SET —á–µ—Ä–µ–∑ model_a, –ø–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –∏ –æ–±—â—É—é –≤—ã–±–æ—Ä–∫—É.
  - –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—ë –≤ ACCURACY_GAUGE.
  - –í–µ—Ä–Ω—É—Ç—å –æ—Ç—á–µ—Ç: model_tested (A), accuracy, correct_predictions, total_samples.
- –í–µ—Å—å —Ü–∏–∫–ª —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª—ã FastAPI –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.

### 4.2. Declarative Content (–î–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö)

- VALIDATION_SET ‚Äî –≤–Ω–µ—à–Ω–∏–π —Å–≤–∏—Ç–æ–∫È™åËØÅ –¥–∞–Ω–Ω—ã—Ö, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –∏ –∏—Å—Ç–∏–Ω–Ω—É—é –º–µ—Ç–∫—É.
- TextInput ‚Äî –±–∞–∑–æ–≤–∞—è —Ñ–∞–±—Ä–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª–µ text (—Å—Ç—Ä–æ–∫–∞) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
- –î—É—Ö –ê (DistilBERT sentiment-analysis) –∏ –î—É—Ö –ë (RoBERTa sentiment-analysis) ‚Äî –¥–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —á–µ—Ä–µ–∑ –ø–∞–π–ø–ª–∞–π–Ω.
- –ü–æ—Ä—Ç–∞–ª/–ê–º—É–ª–µ—Ç ‚Äî FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–ê–º—É–ª–µ—Ç —Å –†–∞–∑–≤–∏–ª–∫–æ–π" —Å –¥–≤—É–º—è —Ç—Ä–æ–ø–∞–º–∏: /analyze –∏ /validate.
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ç–æ—Ä Prometheus ‚Äî –∑–æ–≤—É—â–∏–π –ú–µ—Ç—Ä–∏–∫–∏ –∫ –ì—Ä–∞–Ω–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ (Gauge –∏ Counter).
- –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–Ω–¥–æ–º–∞ ‚Äî –≤–∏–±—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –º–æ–Ω–µ—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –º–µ–∂–¥—É A –∏ B.

Inventory (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤):

- üè∞ –ê–º—É–ª–µ—Ç —Å –†–∞–∑–≤–∏–ª–∫–æ–π ‚Äî FastAPI –ø–æ—Ä—Ç–∞–ª, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –∫–∞–∫ —Ü–µ–ª–µ–≤–æ–π API, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –º–∞—Ä—à—Ä—É—Ç—ã /analyze –∏ /validate.
- üõ°Ô∏è TextInput ‚Äî —á–µ—Ä—Ç—ë–∂ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª–µ text: string.
- üè∞ –î—É—Ö –ê ‚Äî DistilBERT –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ sentiment-analysis –ø–∞–π–ø–ª–∞–π–Ω.
- üè∞ –î—É—Ö –ë ‚Äî RoBERTa –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ sentiment-analysis –ø–∞–π–ø–ª–∞–π–Ω.
- üõ°Ô∏è –ú–∞–Ω–æ–º–µ—Ç—Ä –¢–æ—á–Ω–æ—Å—Ç–∏ ‚Äî Gauge model_accuracy, –∏–∑–º–µ—Ä—è—é—â–∏–π —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ.
- üõ°Ô∏è –ö—Ä–∏—Å—Ç–∞–ª–ª-–°—á–µ—Ç—á–∏–∫ –ó–∞–ø—Ä–æ—Å–æ–≤ ‚Äî Counter model_requests_total, —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏–∑–º–µ—Ä–µ–Ω–∏—è model_version.
- üè∞ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ç–æ—Ä Prometheus ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–±–æ—Ä–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫.
- üè∞ VALIDATION_SET ‚Äî –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∏—Ö –∏—Å—Ç–∏–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π—Å—è –≤ /validate.

## 5. Structural Decomposition (–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

- –ö–ª–∞—Å—Å—ã:
  - TextInput: –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –≤—Ö–æ–¥–∞ (field: text).
- –§—É–Ω–∫—Ü–∏–∏/–ú–∞—Ä—à—Ä—É—Ç—ã:
  - analyze_sentiment: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Ä—à—Ä—É—Ç–∞ POST /analyze.
  - validate_model: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Ä—à—Ä—É—Ç–∞ POST /validate.
- –û–±—ä–µ–∫—Ç—ã:
  - app: FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ê–º—É–ª–µ—Ç —Å –†–∞–∑–≤–∏–ª–∫–æ–π).
  - model_a: –ø–∞–π–ø–ª–∞–π–Ω sentiment-analysis –Ω–∞ DistilBERT.
  - model_b: –ø–∞–π–ø–ª–∞–π–Ω sentiment-analysis –Ω–∞ RoBERTa.
  - ACCURACY_GAUGE: Gauge –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏.
  - REQUEST_COUNTER: Counter –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤.
- –î–∞–Ω–Ω—ã–µ:
  - VALIDATION_SET: –Ω–∞–±–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤ –∏ –∏—Å—Ç–∏–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
  - Validation data –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∏–º–ø–æ—Ä—Ç validation_data.

## 6. System Context & Constraints (–°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)

### 6.1. Technical Constraints

- Performance: Standard CPU
- Concurrency: Sync
- Dependencies: fastapi, pydantic, transformers, prometheus_fastapi_instrumentator, prometheus_client, validation_data (–ª–æ–∫–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å)

### 6.2. Prohibited Actions (Negative Constraints)

- DO NOT store secrets in plain text (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .env –∏–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è).
- DO NOT print raw data –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–∑–∞—â–∏—Ç–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤).
- DO NOT –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ (–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –±—ã –±—ã–ª–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ).
- DO NOT –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (.yaml, .json) –≤ —Å–∫—Ä–∏–ø—Ç—ã.
- DO NOT –º–µ–Ω—è—Ç—å –≤–µ—Ä—Å–∏–∏ –∏–ª–∏ –ø—É—Ç–∏ –≤–æ –≤—Ä–µ–º—è —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.

## 7. Verification & Testing (–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è)

–ì–∞—Ä–≥–µ–ª—å- —Å—Ü–µ–Ω–∞—Ä–∏–∏ (Gherkin)

Feature: Script Functionality
Scenario: Successful sentiment analysis
Given a valid HTTP POST to /analyze with JSON body containing "text": "I love this product!"
When the API processes the request
Then the response status should be 200 OK
And the response JSON should contain a "result" object and a "model_version" field
And the "model_version" value should be either "A" or "B"

Scenario: Validation endpoint returns performance report
Given a HTTP POST to /validate
When the validation routine runs against VALIDATION_SET
Then the response status should be 200 OK
And the response JSON should include: - model_tested: "A" - accuracy: a float between 0 and 1 - correct_predictions: an integer - total_samples: an integer

Scenario: Invalid input to analyze endpoint
Given an HTTP POST to /analyze with an empty body or missing "text" field
When the API processes the request
Then the response status should be 422 Unprocessable Entity
And the response indicates a validation error for the "text" field

–ò–¢–û–ì–û–í–´–ô –ê–†–¢–ï–§–ê–ö–¢: main.py

Independent Artifact: –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ —Ç–æ—á–Ω—ã—Ö —Å–≤—è–∑–µ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã, –ø–æ–º–µ—Ç—å—Ç–µ –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç.
