# === docker-compose.yml (для Квеста 30.1) ===
# Великое Заклинание Оркестрации для "Проверки на Прочность".

# Указываем версию грамматики, которую мы используем. '3.8' — современный и надежный выбор.
version: "3.8"

# Начинаем перечень "служб" — отдельных духов, которых мы призываем в наш оркестр.
services:
  # --- СЛУЖБА I: ЦЕЛЬ (Сторожевая Башня) ---
  # Это наш осаждаемый артефакт из Квеста 29.2.
  target-app:
    # `build` — приказ Духу Docker сотворить "Слепок" (образ) для этой службы.
    build:
      # `context` — руна, указывающая, где лежат чертежи (`Dockerfile` и др.).
      # Мы указываем, что чертежи для этой службы лежат в соседней мастерской Квеста 29.2.
      context: ../../Scroll_29/Quest_2
    # Мы накладываем "Печать Имени", даруя "Цели" ее истинное, каноническое имя,
    # которое она получила при своем сотворении в Квесте 29.2.
    image: codex/app-29-2-telemetry
    # `ports` — руна, создающая "магический портал" между миром контейнера и твоим миром.
    ports:
      # Мы "пробрасываем" порт 8000 из контейнера в порт 8000 твоего мира.
      # Это позволит Locust'у (и твоему браузеру) "достучаться" до API.
      - "8000:8000"
    # `hostname` — даем службе каноническое имя внутри ее "карманного измерения" (сети Docker).
    # Это имя позволит другим службам (Locust) находить ее.
    hostname: target-app

  # --- СЛУЖБА II: ОСАДНАЯ МАШИНА (Locust) ---
  # Это наш иллюзорный легион.
  locust-tester:
    # Приказываем сотворить "Слепок" и для этой службы.
    build:
      # Чертежи для этой службы (`Dockerfile` для Locust, `locustfile.py`) лежат в текущей мастерской.
      context: .
    # Мы накладываем "Печать Имени", даруя сотворенной "душе" Голема каноническое имя.
    image: codex/locust-30-1-tester
    # Создаем портал для "Командного Пункта" Locust.
    ports:
      # Мы пробрасываем порт 8089 (веб-интерфейс Locust) в наш мир.
      - "8089:8089"
    # `command` — это заклинание, которое будет произнесено при пробуждении духа ВНУТРИ контейнера.
    # Мы приказываем Locust'у немедленно начать осаду, используя наш "План Осады" (`-f /app/locustfile.py`)
    # и указывая ему цель (`--host http://target-app:8000`).
    command: locust -f /app/locustfile.py --host http://target-app:8000
    # `depends_on` — руна, устанавливающая порядок пробуждения.
    # Наш легион не может начать осаду, пока крепость не будет полностью построена и готова.
    depends_on:
      # Указываем, что служба 'locust-tester' зависит от службы 'target-app'.
      - target-app
