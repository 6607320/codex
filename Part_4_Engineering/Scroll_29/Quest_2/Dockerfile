# Используем стандартный, полный образ Python. Он больше, но надежнее.
FROM python:3.10

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем свиток зависимостей
COPY requirements.lock .

# Устанавливаем зависимости НАПРЯМУЮ в финальный образ
RUN pip install --no-cache-dir -r requirements.lock

# Копируем ВСЕ пергаменты из нашей мастерской
COPY . .

# --- Толкование: Скрипт Пробуждения (start.sh) ---
# Мы используем отдельный скрипт `start.sh`, а не просто `CMD ["uvicorn"...]`,
# чтобы гарантированно исполнить 'Главное Заклина
# Этот метод защищает нас от 'проклятия кодировок' (`exec format error`) и
# позволяет гибко использовать 'секретную руну окружения' `${PORT}`,
# которую диктует Облачная Цитадель (`Cloud Run`).

# Мы накладываем "Руну-Печать Разрешения" (`chmod +x`), даруя пергаменту `start.sh` "право на жизнь".
RUN chmod +x ./start.sh
# Мы накладываем "Главное Заклинание Жизни" (`CMD`), приказывая Голему при своем пробуждении исполнить `start.sh`.
CMD ["./start.sh"]
