# start.sh Specification

## 1. Meta Information

- Domain: Scripting
- Complexity: Low
- Language: Bash
- Frameworks: uvicorn, Python, FastAPI-ish ASGI app
- Context: ../AGENTS.md

## 2. Goal & Purpose (Цель и Назначение)

- Context for Creator: Этот Ритуал запускает ASGI-сервер через врожденный мост uvicorn, чтобы приложение main:app стало доступно на всех интерфейсах через порт, указанной Эфирной переменной PORT.
- Instruction for AI: This section provides the high-level intent. Используйте понимание причины кода для корректной конфигурации и поведения при запуске. Легенда ниже объясняет зачем нужен данный Ритуал.

Легенда: Этот стартовый Скрижаль призывает к жизни веб-приложение, оживляя Эфир через uvicorn и направляя его слушать на адрес 0.0.0.0 и порт, взятый из окружения PORT. Ритуал не только запускает приложение, но и передаёт управляющий контекст внешнему мирy, поддерживая связь между сетями и кодом.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- Source: CLI Args
- Format: Text
- Schema:
  interface InputData {
  port?: number;
  host?: string;
  app?: string;
  }

### 3.2. Outputs (Выходы)

- Destination: STDOUT
- Format: JSON
- Success Criteria: Exit Code 0
- Schema:
  interface OutputResult {
  started: boolean;
  pid?: number;
  url?: string;
  error?: string;
  }

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

1. Сначала Ритуал читает Эфир PORT из окружения. Если PORT не задан, он подбрасывает DEFAULT_PORT и шепчет предупреждение в Хаос о отсутствии явного порта.
2. Затем проверяет наличие артефакта uvicorn в путях сервера. Если uvicorn недоступен, Ритуал выводит ясное сообщение о Хаосе и завершает работу с ненулевым кодом.
3. Согласовывает заклинание запуска: uvicorn main:app —host 0.0.0.0 —port PORT. Адрес прослушивания фиксированно задан как 0.0.0.0.
4. Внезапно вызывает этот заклинательный модуль и передаёт управление в АСГИ-сервер uvicorn. В этот момент Ритуал остаётся в роли Хозяина процесса, пока сервер не завершит работу.
5. При завершении uvicorn завершает работу и Ритуал ложно не прерывает поток, а возвращает статус завершения в соответствии с кодом выхода uvicorn.
6. В случае получения сигналов завершения они передаются серверу, чтобы разорвать связь корректно и сохранить целостность Эфира.

Хаосы и ошибки трактуются как нестыковки окружения или отсутствия необходимых артефактов. В таких случаях Ритуал сообщения об ошибке направляет на Эфир и завершает работу с соответствующим кодом.

### 4.2. Declarative Content (Для конфигураций и данных)

- Эфир PORT используется как ключ портированного доступа. Значение по умолчанию — 8000, если порт не задан.
- Адрес прослушивания — 0.0.0.0, что позволяет доступ извне по любому сетевому интерфейсу.
- Приложение, которое разворачивает Rитуал — main:app. Этот объект обрабатывает входящие запросы и возвращает ответы через ASGI-слой.
- Команда запуска — uvicorn main:app —host 0.0.0.0 —port PORT, которая активирует Ритуал и превращает Эфир в живой поток сервисов.

## 5. Structural Decomposition (Декомпозиция структуры)

- Launcher (главная линия Ритуала start.sh): координация чтения порта, проверки зависимостей и запуска uvicorn.
- EnvLoader (Загрузчик окружения): извлекает PORT и устанавливает дефолты, если требуется.
- DependencyVerifier (Проверник зависимостей): удостоверяется, что uvicorn доступен в окружении.
- ServerSpawner (Запускатель Сервера): формирует команду запуска и передаёт её uvicorn, поддерживая возможность обработки сигналов.
- Orchestrator (Оркестратор): управляет жизненным циклом процесса и обработкой ошибок.

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- Performance: Standard CPU, обычная нагрузка, без специальных требований к графике или памяти.
- Concurrency: Асинхронная обработка запросов внутри uvicorn; сам Ритуал запуска синхронный.
- Dependencies: uvicorn, Python, main:app (модуль приложения, который uvicorn грузит).

### 6.2. Prohibited Actions (Negative Constraints)

- DO NOT store secrets in plain text (используйте переменные окружения или секреты).
- DO NOT print raw data в консоль в продакшен режиме, если это не специально предусмотрено логированием.
- DO NOT использовать синхронные сетевые вызовы в главном цикле программы.
- DO NOT оборачивать конфигурационные файлы (.yaml, .json) внутрь скриптов (как часть исполняемого кода).
- DO NOT изменять версии или пути во время реконструкции артефакта.

## 7. Verification & Testing (Верификация)

1-2 Gherkin Scenarios:

Feature: Script Functionality of start.sh
Scenario: Successful startup
Given PORT is set to 8080
When the start.sh ritual is invoked
Then uvicorn starts and binds to 0.0.0.0:8080 and the process remains running

Scenario: Port missing
Given PORT is unset
When the start.sh ritual is invoked
Then the script exits with a non zero status and reports a port-related error

ИССЛЕДУЕМЫЙ АРТЕФАКТ: start.sh

ИСХОДНЫЙ КОД:

- Шаги хаотично сдерживаются в виде ритуала, но основа проста: Ритуал читает PORT, запускает uvicorn main:app на 0.0.0.0:PORT и поддерживает связь с Эфиром до завершения работы.

Пояснение к заголовку:

- Заголовок заменён на имя файла start.sh в соответствии с указанием.
- Весь текст сохранён в стиле Прикладной Техномагии: скрипт — Ритуал, конфигурация — Скрижаль, данные — Эфир, ошибки — Хаос.
- Имена переменных и путей сохранены как есть: start.sh, uvicorn, main:app, 0.0.0.0, PORT.
