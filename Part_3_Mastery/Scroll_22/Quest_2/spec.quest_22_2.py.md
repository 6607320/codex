# quest_22_2.py Specification

## 1. Meta Information

- **Domain:** Scripting
- **Complexity:** Medium
- **Language:** Python
- **Frameworks:** PyTorch, transformers, datasets
- **Context:** Independent Artifact

## 2. Goal & Purpose (Легенда)

Этот ритуал демонстрирует паттерн индексирования и поиска через Мага CLIP: мы создаём Галерею Артефактов из изображений, вычисляем их ауры (эмбеддинги), затем применяем Магический Компас к текстовому запросу и выбираем артефакт с наивысшей резонансной гармонией. Это иллюстративный пример решения задачи семантического поиска в контексте домена переноса знаний между объектами.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- **Source:** N/A ( Script автономен; не принимает внешние входы во время выполнения )
- **Format:** N/A
- **Schema:**

* InputData: пустой контракт, входные данные не приходят извне; все параметры задаются внутри ритуала (например, имя модели, набор меток и запрос).

### 3.2. Outputs (Выходы)

- **Destination:** STDOUT
- **Format:** Text
- **Success Criteria:** Exit Code 0
- **Schema:**

* OutputResult: {
  status: "success" | "failure",
  artifactFound?: string,
  note?: string
  }

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

1. Определение устройственного аркана: выбрать CUDA как место пребывания маны, если доступно; иначе использовать CPU.
2. Призыв CLIP: загрузить модель и её Толмача (processor) по имени openai/clip-vit-base-patch32 и привести к выбранному устройству.
3. Создание Галереи Артефактов: открыть галерею из набора cifar100 в режиме стриминга; задать заказ на четыре класса: кот, рыба, трактор, тюльпан (маркеры: 20, 35, 86, 72); по каждому найденному элементу сохранять изображение под названием артефакта и удалять его из списка ожидания; прерывать сбор, когда заказ выполнен.
4. Индексация Галереи: привести изображения к RGB, прогнать через процессор и получить векторные ауры изображений (image_features) одним заходом, сохранив их для последующего сравнения.
5. Магический Поиск: задать текстовый запрос "маленький котенок", преобразовать его в текстовую аурую (text_features), затем посчитать резонансы между каждой аурой изображения и аурой запроса посредством умножения матриц; выбрать артефакт с наивысшей гармонией (argmax).
6. Вердикт и завершение: вывести имя найденного артефакта и сообщить о завершении ритуала; при отсутствии полного набора артефактов — корректно завершить с частичным результатом.
7. Защита от хаоса: любые ошибки во время выполнения аккуратно обрамляются сообщениями и не ломают общий цикл, чтобы сохранить целостность ритуала.

### 4.2. Declarative Content (For Configs & Data)

[Здесь представлены точные данные для воспроизведения 1-в-1:]

- Модель и Толмач: openai/clip-vit-base-patch32
- Устройство: CUDA, если доступно, иначе CPU
- Галерея источника: CIFAR-100, split: train, streaming: True
- Заказ артефактов: mappings = {20: "кот", 35: "рыба", 86: "трактор", 72: "тюльпан"}
- Эталонный текст запроса: "маленький котенок"
- Этапы индексации: конвертация изображений в RGB; обработка через CLIPProcessor; получение image_features
- Этапы поиска: получение text_features и сравнение с image_features по скалярному произведению

## 5. Structural Decomposition (Декомпозиция структуры)

- Установка устройства и загрузка Голема CLIP (DEVICE, CLIPModel, CLIPProcessor)
- Формирование Галереи Артефактов (streaming CIFAR-100, labels_to_find, gallery)
- Индексация Галереи (gallery_images, image_inputs, image_embeddings)
- Магический Поиск (search_query, text_inputs, text_embedding, similarities, best_match)
- Вывод и завершение (печать результатов, финальные сообщения)

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- **Performance:** В большую часть времени выполняется на GPU (CUDA) при наличии; в противном случае на CPU.
- **Concurrency:** Синхронный режим; обработка идёт последовательно для каждого шага.
- **Dependencies:** torch, datasets, transformers

### 6.2. Prohibited Actions (Negative Constraints)

- DO NOT store secrets in plain text (используйте .env или секретные хранилища).
- DO NOT print сырые данные в консоль в продакшн-режиме.
- DO NOT выполнять сетевые вызовы синхронно в критических циклах без необходимости.
- DO NOT оборачивать конфиги (.yaml, .json) в скрипты без явной нужды.
- DO NOT менять версии библиотек или пути во время реконструкции артефакта.

## 7. Verification & Testing (Верификация)

### Герхин сценарии

Feature: Semantical search ritual via CLIP

Scenario: Successful execution
Given поток данных CIFAR-100 доступен и содержит метки 20, 35, 86, 72
When ритуал выполняется до окончания Индексации и Поиска
Then Магический Компас указывает на артефакт из галереи и выводит его имя
And ритуал завершается сообщением о завершении

Scenario: Incomplete gallery (edge case)
Given поток данных доступен, но части заказанного набора недоступны
When ритуал пытается найти соответствие по запросу
Then Компас выдаёт лучший доступный матч из найденной галереи
And ритуал завершается без критической ошибки, с уведомлением об частичном результате

Интерактивные сообщения в ходе ритуала будут включать термины ветви крови магии: дух Эфира, ауры изображений и резонансы между аурой текста и аурами артефактов.
