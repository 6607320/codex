# main.py Specification

## 1. Meta Information

- Domain: Scripting
- Complexity: Medium
- Language: Python
- Frameworks: FastAPI, Pydantic, transformers
- Context: ../AGENTS.md

## 2. Goal & Purpose (Цель и Назначение)

Context for Creator: Это чертёж для скрипта-артефакта, который выступает духом внутри Docker-контейнера. Он создаёт портальный сервис по анализу эмоциональной окраски текста и возвращает результат анализа. Инструмент демонстрирует воспроизводимость развёртывания и готовность к интеграции в сервисную среду.  
Instruction for AI: Это описание задаёт WHY: зачем нужен этот файл — подготовить сервис эмпатического анализа текста для развёртывания в любом окружении.

Описание: Этот модуль реализует FastAPI-приложение, внутри которого запускается дух анализа эмоций (sentiment-analysis) через pipeline библиотеки transformers. Он принимает текстовое сообщение, прогоняет его через модель и возвращает первую запись результата анализа в виде JSON. Скрипт задуман не как самостоятельный сервис на продакшене, а как "душа" тела, которая затем может быть запечатана в Docker-контейнер (Body/Container) согласно инструкциям к заданию.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- Source: API Request
- Format: JSON
- Schema:
  - InputData имеет поле text: string
  - Пример входа в реальном мире: объект с ключом "text" и значением текстовой строки

### 3.2. Outputs (Выходы)

- Destination: API Response
- Format: JSON
- Success Criteria: 200 OK
- Schema:
  - OutputResult имеет поле result, где result — это словарь с ключами label: string и score: number
  - Пример структуры результата: { "result": { "label": "POSITIVE", "score": 0.93 } }

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

1. Включение артефакта: создаётся магический портал FastAPI с титулом и описанием, который станет сердцем контура взаимодействия.
2. Призыв духа анализа: создаётся дух Эмоций через ритуал инициализации pipeline с задачей sentiment-analysis и точной моделью distilbert-base-uncased-finetuned-sst-2-english.
3. Определение чертежа сообщения: формируется структура Message, где одно поле text прописано как строка. Это позволяет порталу принимать входящие послания в виде JSON с полем text.
4. Построение портала: создаётся главный артефакт app с именем, описанием и версией, который будет связывать внешний мир с духом анализа.
5. Врата портала: открывается точка доступа POST по адресу /analyze. Входное сообщение валидируется по схеме TextInput, и FastAPI автоматически обрабатывает целостность данных.
6. Призыв к действию: текст из входящего послания передаётся в дух анализа, результат расчётов возвращается обратно через портальный ответ в формате JSON.
7. Пробуждение порога: портал сам по себе не запускается автоматически; для активации нужен внешний запуск через uvicorn с указанием модуля и артефакта, например uvicorn main:app --reload.
8. Эхо хаоса: если данные не проходят валидацию, система возвращает сигналы ошибок в формате HTTP, управляя Хаосом через встроенные механизмы FastAPI.

### 4.2. Declarative Content (Для конфигураций и данных)

- Основной артефакт: FastAPI портал, называемый Говорящий Амулет Техноманта.
- Дух анализа: sentiment_analyzer, инициализированный через transformers pipeline с моделью DistilBERT SST-2.
- Чертеж сообщений: TextInput с полем text (строка).
- Врата доступа: эндпойнт POST /analyze, принимающий TextInput, возвращающий результат анализа.

## 5. Structural Decomposition (Декомпозиция структуры)

- app: экземпляр FastAPI, оглашающий тьмы и свет UI портала.
- TextInput: описывает форму входного сообщения (поле text).
- sentiment_analyzer: дух-аналитик, созданный через pipeline("sentiment-analysis", model="distilbert-base-uncased-finetuned-sst-2-english").
- analyze_sentiment: функция-ворота, принимающая TextInput, вызывающая анализ и возвращающая результат.
- Endpoint: POST /analyze — обеспечивает взаимодействие с внешним миром и возврат результата.

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- Performance: стандартный CPU, обычная задержка на инференс модели в рамках локального сервиса; ориентация на устойчивое поведение в контейнере.
- Concurrency: синхронная обработка запроса (def analyze_sentiment) в рамках FastAPI; поддержка параллелизма через механизм ASGI, но конкретная функция не помечена async.
- Dependencies: FastAPI, Pydantic, transformers (pipeline), модель DistilBERT SST-2 English.

### 6.2. Prohibited Actions (Negative Constraints)

- DO NOT store secrets in plain text (use .env).
- DO NOT print raw data to console in production mode.
- DO NOT use synchronous network calls in the main loop.
- DO NOT wrap configuration files (.yaml, .json) into scripts.
- DO NOT change versions or paths during reconstruction.

## 7. Verification & Testing (Верификация)

Геркин-сценарии

Функциональность: Скрипт-портал анализа эмоций

Сценарий 1: Успешное выполнение

- Утверждение: Предусловия обеспечены корректной конфигурацией и работающим сервисом.
- Действие: Выполнить POST запрос к /analyze с телом {"text": "I am happy"}.
- Ожидание: Ответ — статус 200 OK и JSON-модель результата с полем result, содержащим label и score.

Сценарий 2: Ошибка ввода

- Утверждение: Отсутствуют обязательные поля или данные неверны.
- Действие: Выполнить POST запрос к /analyze без поля text.
- Ожидание: Ответ — ошибка валидации (HTTP 422) и сообщение об ошибке.

ИССЛЕДУЕМЫЙ АРТЕФАКТ: main.py

ИСТОРИЯ ЭПИЗОДА (Lore)
Этот артефакт — часть большого ряда квестов по сборке переносимых AI-сервисов. Его задача — показать, как духи ML сервиса рождаются внутри портала и как они могут быть размещены в Docker-окружении, сохраняя воспроизводимость и предсказуемость поведения. Основной принцип — отделить «душу» (логика анализа) от «тела» (контейнера) и дать ясный путь к развёртыванию в любой среде.
