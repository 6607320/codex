# === quest_3_1.py ===
# Квест: 3.1 - Призыв "Всевидящего Ока"
# Цель: Познакомиться с магией Компьютерного Зрения (Computer Vision).
# Мы призовем "духа", способного распознавать объекты на изображениях,
# и проведем простой ритуал классификации.

# --- Акт 1: Подготовка Гримуаров ---

# Призываем "Библиотекаря" для надежного получения "учебных" изображений.
from datasets import load_dataset

# Призываем наш универсальный "амулет" для простого использования моделей.
from transformers import pipeline

# --- Акт 2: Призыв Магического Образа ---

# Сообщаем о начале ритуала.
print("Открываю портал в 'Вечный Сад Образов' (CIFAR-10)...")
# Открываем "портал" к архиву 'cifar10'.
# CIFAR-10 - это классический архив из 60,000 маленьких картинок 32x32,
# разделенных на 10 классов (самолет, кот, собака и т.д.).
# Мы используем streaming=True, чтобы не скачивать весь архив, а взять
# только один образец.
dataset = load_dataset(
    "cifar10", split="train", streaming=True, trust_remote_code=True
)
# Берем первый попавшийся образец из потока.
sample = next(iter(dataset))

# Внутри 'sample' находится словарь. Сам образ (объект Pillow) лежит под ключом 'img'.
image_to_analyze = sample["img"]

# Сообщаем об успехе.
print("Магический образ успешно призван!")

# Это дополнительный, но важный шаг для самопроверки.
# Мы заглядываем в "паспорт" архива, чтобы узнать "правильный ответ".
# sample['label'] содержит номер класса (например, 3).
# dataset.info.features['label'].int2str(...) переводит этот номер в
# понятное слово (например, 'cat').
true_label = dataset.info.features["label"].int2str(sample["label"])
print(f"(Истинная суть образа, как говорят хроники: {true_label})")

# --- Акт 3: Ритуал Распознавания ---

# Сообщаем о призыве "духа". При первом запуске он будет скачан.
print("\nПризываю 'Всевидящего Око'...")
# Создаем "амулет" pipeline для новой задачи.
# 1. "image-classification" - Название задачи. Мы хотим "классифицировать изображение".
# 2. model="google/mobilenet_v2_1.0_224" - Имя "духа". MobileNetV2 - это быстрая
#    и легкая модель, созданная Google, идеально подходит для нашего Кристалла Маны.
vision_spirit = pipeline(
    "image-classification", model="google/mobilenet_v2_1.0_224"
)

# Сообщаем о начале анализа.
print("\nДух всматривается в образ...")
# "Скармливаем" наш образ (image_to_analyze) "амулету" (vision_spirit).
# "Амулет" сам изменит размер картинки, нормализует цвета и проведет анализ.
result = vision_spirit(image_to_analyze)

# --- Акт 4: Демонстрация Результата ---

# Выводим заголовок.
print("\nВердикт 'Всевидящего Ока':")
# Печатаем результат. Это будет список из 5 самых вероятных, по мнению "духа",
# классов с их "уверенностью" (score). Мы можем сравнить этот вердикт с "истинной сутью",
# которую мы узнали на Акте 2.
print(result)
