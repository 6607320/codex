# quest_20_2.py Specification

## 1. Meta Information

- Domain: ML/NLP
- Complexity: High
- Language: Python
- Frameworks: matplotlib, numpy, pandas, torch, sklearn
- Context: ../AGENTS.md

## 2. Goal & Purpose (Цель и Назначение)

Context for Creator: Разделить путь от подготовки летописи времени до торжественного экзамена Голема-Оракула: обучить LSTM на временных рядах, показать цикл подготовки данных, архитектуру голема, наставление и экзамен, завершив визуализацией предсказаний.
Instruction for AI: Этот модуль учит, как на основе исторических значений и их нормализации строить предсказания будущих точек времени, демонстрируя ограниченности и силу LSTM в поединке с сезонностью.

Описание: Создание Оракула — Голема-Оракула на основе слоя nn.LSTM. Ритуал включает: подготовку летописи времени, проектирование архитектуры, обучение, экзамен на данных и визуализацию результатов, чтобы наглядно продемонстрировать работу модели и её пределы в экстрапции тренда.

## 3. Interface Contract (Интерфейсный Контракт)

### 3.1. Inputs (Входы)

- Source: CLI Args
- Format: JSON
- Schema:
  interface InputData {
  filePath: string; // путь к CSV файлу, например "time_series_data.csv"
  dateColumn: string; // имя колонки с датами, например "date"
  valueColumn: string; // имя колонки с значениями, например "value"
  seqLength: number; // длина окна последовательности, например 10
  device?: 'cpu' | 'cuda'; // устройство исполнения
  }

### 3.2. Outputs (Выходы)

- Destination: File | STDOUT
- Format: JSON
- Success Criteria: 200 OK | Exit Code 0
- Schema:
  interface OutputResult {
  success: boolean;
  message?: string;
  plotPath?: string; // путь к артефакту визуализации, например "oracle_prediction.png"
  details?: { epochCount?: number; finalLoss?: number };
  }

## 4. Implementation Details (The Source DNA / Исходный Код)

### 4.1. Algorithmic Logic (Для исполняемого кода)

1. Загрузить летопись времени из файла time_series_data.csv, извлекая колонки date и value. Привести значения к числовому типу.
2. Разделить летопись на учебную часть (train_data) и экзаменационную (test_data): все значения кроме последних 65 — для обучения; последние 65 — для экзамена.
3. Применить нормализацию MinMaxScaler к диапазону [-1, 1] к учебной части данных.
4. Создать учебные карточки: для каждой позиции i в диапазоне 0..(длина(train_data_norm) - seqLength) взять последовательность из seqLength значений и целевое значение, равное следующему после окна. Вернуть X_train и y_train в виде numpy массивов.
5. Преобразовать X_train и y_train в тензоры PyTorch (float) и подготовить на устройстве DEVICE.
6. Определить архитектуру Голема-Оракула: LSTM слой с входной размерностью 1, скрытым слоем заданной величины (например 100), линейный слой преобразования к одному выходному значению.
7. Инициализировать скрытые состояния и запустить цикл обучения: для каждой эпохи и каждой пары (последовательность, ответ) запускать прямой проход, рассчитывать среднеквадратичную ошибку (MSELoss), обратно распространять ошибку и шагать оптимизатором Adam с lr = 0.001. Обнулять память перед каждой карточкой.
8. Периодически выводить прогресс (например, каждые 25 эпох) с текущей ошибкой.
9. После наставления перевести модель в режим экзамена: взять последние seqLength значений учебной части как затравку и по шагам генерировать предсказания для каждого дня экзамена, без вычисления градиентов и с переинициализацией памяти головного голема перед каждым предсказанием.
10. Обратное масштабирование предсказаний с помощью inverse_transform, чтобы вернуть их в исходный масштаб.
11. Визуализация: построить график полной летописи и предсказаний Оракула, отметить начало экзамена вертикальной линией, сохранить график как oracle_prediction.png и вывести путь к артефакту.

### 4.2. Declarative Content (Для конфигураций и данных)

Указ Ткачу: конфигурация и данные должны следовать следующему формату и структуре, пригодной для воспроизведения 1-в-1:

- Файл CSV time_series_data.csv содержит две колонки: date (строка формата YYYY-MM-DD) и value (число, плавающее или целое).
- Колонка date служит осью времени, колонка value — значения серии.
- Разделение данных: учебная часть состоит из всех строк кроме последних 65, экзаменационная — из последних 65 строк.
- Перед обучением данные проходят нормализацию в диапазон [-1, 1] через MinMaxScaler.
- Окно последовательности seqLength равно 10.
- Путь к файлу графика: oracle_prediction.png.
- Устройство выполнения определяется автоматически: если доступна CUDA, используется GPU, иначе CPU.

ИССЛЕДУЕМЫЙ АРТЕФАКТ: quest_20_2.py

## 5. Structural Decomposition (Декомпозиция структуры)

- Функции
  - create_sequences(data, seq_length): формирует пары (последовательность, метка) из нормализованных данных.
- Классы
  - OracleLSTM(nn.Module): реализует LSTM-голема с линейным выходом; хранит скрытое и ячейковое состояние памяти и определяет прямой проход forward.
- Главный блок
  - if **name** == "**main**": последовательность действий: загрузка данных, подготовка, создание обучающих карточек, настройка модели и среды, обучение, экзамен и визуализация.

## 6. System Context & Constraints (Системный контекст и Ограничения)

### 6.1. Technical Constraints

- Performance: выполнение в стандартном окружении CPU; возможно ускорение на CUDA при наличии.
- Concurrency: синхронный режим обучения; отсутствуют асинхронные параллельные вычисления в главном цикле.
- Dependencies: matplotlib, numpy, pandas, torch, sklearn (MinMaxScaler).

### 6.2. Prohibited Actions (Negative Constraints)

- НЕ хранить Secrets в открытом виде.
- НЕ печатать сырые данные в консоль в продакшн-режиме.
- НЕ использовать синхронные сетевые вызовы в основном цикле обучения.
- НЕ оборачивать конфигурационные файлы (.yaml, .json) прямо в исполняемые скрипты.
- НЕ менять версии библиотек или путей во время реконструкции.
- НЕ копировать код в объяснение — только описание и логика.

## 7. Verification & Testing (Верификация)

1. Гидеальная дорожка (Happy Path)
   Feature: Oracle artifact execution
   Scenario: Successful execution
   Given time_series_data.csv exists в рабочей директории с двумя колонками date и value
   When скрипт quest_20_2.py запускается
   Then создаётся артефакт oracle_prediction.png и выводятся сообщения о прогрессе наставления

2. Ошибочный сценарий
   Feature: Oracle artifact execution
   Scenario: Missing or malformed data
   Given time_series_data.csv отсутствует или имеет неправильную структуру
   When скрипт quest_20_2.py запускается
   Then процесс завершается с сообщением об ошибке и без создания графика

— Легенда выполнена, артефакт готов к записи в Великую Книгу Кодекса.
