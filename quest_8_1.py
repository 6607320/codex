# === quest_8_1.py ===
# Квест: 8.1 - Техника "Прореживания Кадров"
# Цель: Освоить Frame Sampling - одну из ключевых техник оптимизации
# для работы с видео. Мы научимся обрабатывать не каждый кадр,
# а только каждый N-ный, что значительно ускоряет анализ.

# --- Акт 1: Подготовка Гримуаров ---

# Призываем "Набор Кинематографиста" (OpenCV).
import cv2
# Призываем помощника 'os' для работы с файлами и папками.
import os

# --- Акт 2: Настройка Ритуала ---

# Готовим "ящик" для наших "прореженных" карт-кадров.
output_folder = 'sampled_frames'
# Создаем папку, если ее еще не существует.
os.makedirs(output_folder, exist_ok=True)

# Устанавливаем "правило отбора": будем брать только каждый 3-й кадр.
# Это наш главный гиперпараметр, который мы можем менять.
frame_skip = 3 

# --- Акт 3: Ритуал Прореживания ---

print("Открываю кинопленку 'test_video.mp4' для прореживания...")
# "Захватываем" видеофайл, создавая "объект-проигрыватель".
video_capture = cv2.VideoCapture('test_video.mp4')

# Готовим два счетчика для статистики.
total_frames_read = 0 # Сколько всего кадров мы "увидели".
frames_saved = 0      # Сколько из них мы решили сохранить.

# Запускаем бесконечный цикл для "пролистывания" кинопленки.
while True:
    # Читаем следующий кадр.
    success, frame = video_capture.read()
    
    # Если кадры закончились (success=False), прерываем ритуал.
    if not success:
        break
        
    # Увеличиваем счетчик "увиденных" кадров.
    total_frames_read += 1
    
    # ГЛАВНАЯ МАГИЯ: "Магический Фильтр"
    # `%` - это заклинание "остаток от деления".
    # Мы делим номер текущего кадра на наше "правило отбора" (3).
    # Если остаток равен 0 (то есть число делится нацело)...
    if total_frames_read % frame_skip == 0:
        # ...только в этом случае мы выполняем ритуал сохранения.
        
        # Создаем уникальное имя для сохраняемого кадра.
        frame_filename = os.path.join(output_folder, f"frame_{frames_saved}.jpg")
        # Сохраняем кадр на диск.
        cv2.imwrite(frame_filename, frame)
        # Увеличиваем счетчик сохраненных кадров.
        frames_saved += 1
        
# --- Акт 4: Завершение ---

# "Освобождаем" видеофайл.
video_capture.release()
# Выводим подробный отчет о проделанной работе.
print(f"\nРитуал завершен.")
print(f"  Всего прочитано кадров: {total_frames_read}")
print(f"  Сохранено (каждый {frame_skip}-й): {frames_saved} кадров в папку '{output_folder}'.")